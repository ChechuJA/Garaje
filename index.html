<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plazas Garaje ‚Äî An√°lisis interactivo</title>
  <style>
    :root{
      --bg:#f3f6ff;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#0066cc;
      --accent-2: #7c3aed;
      --success:#0a8a3a;
      --danger:#d64545;
      --glass: rgba(255,255,255,0.6);
    }
    html,body{height:100%;margin:0}
    body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:1200px;margin:18px auto;padding:0 16px;background:linear-gradient(180deg,#e9f0ff 0%, #f9fbff 100%);color:#0f172a}
    header.appbar{display:flex;align-items:center;gap:12px;padding:18px;border-radius:12px;background:linear-gradient(90deg,var(--accent),var(--accent-2));box-shadow:0 8px 30px rgba(60,80,120,0.12);color:#fff;margin-bottom:18px}
    header.appbar h1{margin:0;font-size:1.2rem;font-weight:700}
    .container{background:var(--card);padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(20,30,60,0.03)}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .controls label, .controls select, .controls input {font-size:0.95rem}
    .badge{display:inline-block;padding:6px 12px;background:linear-gradient(90deg,#eef6ff,#e8f0ff);color:var(--accent);border-radius:999px;font-weight:700;border:1px solid rgba(3,102,204,0.08)}
    .actions{margin-top:12px}
    .hint{color:var(--muted);font-size:0.95rem}
    button{padding:8px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:linear-gradient(180deg,#fff,#fbfdff);cursor:pointer;box-shadow:0 2px 6px rgba(12,20,40,0.04)}
    button.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;border:none;box-shadow:0 6px 18px rgba(124,58,237,0.12)}
    button.positive{background:linear-gradient(90deg,#10b981,#059669);color:#fff;border:none}
    button.danger{background:linear-gradient(90deg,#f97316,#ef4444);color:#fff;border:none}
    button:hover{transform:translateY(-1px)}
    table{width:100%;border-collapse:collapse;margin-top:12px;border-radius:6px;overflow:hidden;box-shadow:0 4px 12px rgba(20,30,60,0.04)}
    th,td{padding:10px 12px;text-align:left}
    thead th{background:linear-gradient(180deg,#fff,#fbfdff);border-bottom:1px solid #eef3ff}
    tbody tr:nth-child(even){background:linear-gradient(90deg,#ffffff,#fbfbff)}
    tbody tr:hover{background:linear-gradient(90deg,#fffbe6,#f7fbff);transform:translateY(0);}
    tr.selected{background:linear-gradient(90deg,#f0fff4,#e9fff0)}
    tr.sold td{opacity:0.5;text-decoration:line-through}
    .meta{color:var(--muted);font-size:0.9rem}
    .controls-right{margin-left:auto;display:flex;gap:8px;align-items:center}
    @media (max-width:800px){
      .controls{flex-direction:column;align-items:stretch}
      header.appbar{flex-direction:column;align-items:flex-start}
      body{font-size:16px}
      button{min-height:44px;font-size:16px}
      input{min-height:44px;font-size:16px}
      th,td{padding:12px 8px;font-size:15px}
      .badge{font-size:14px;padding:8px 12px}
      #floatingChatBtn{width:70px;height:70px;font-size:32px;bottom:16px;right:16px}
      #floatingChatWindow{width:95vw;max-width:none;height:70vh;bottom:100px;right:2.5vw}
    }
    /* sort arrows */
    th .sort-arrow{margin-left:6px;font-size:0.8em;opacity:0.6;display:inline-flex;flex-direction:column;line-height:0.8}
    th .sort-arrow .arrow{font-size:0.8em;opacity:0.35;padding:0 4px;cursor:pointer;display:inline-block}
    th.sorted .sort-arrow .arrow{opacity:0.9}
    th.sorted.asc .sort-arrow .arrow.asc{font-weight:700}
    th.sorted.desc .sort-arrow .arrow.desc{font-weight:700}
  </style>
    <style>
      /* compact action buttons */
      td button{border-radius:8px;padding:6px 8px;margin-right:6px;font-size:0.95rem;border:1px solid rgba(0,0,0,0.04)}
        td button.fav{background:linear-gradient(90deg,#fff8f0,#fff2f0);border:1px solid rgba(255,140,0,0.12)}
        td button.note{background:linear-gradient(90deg,#fffbf0,#fff9f0);border:1px solid rgba(250,204,21,0.08)}
        td button.sold{background:linear-gradient(90deg,#f8fafc,#fff);border:1px solid rgba(0,0,0,0.04)}
        td button.fav:hover{box-shadow:0 6px 16px rgba(255,140,0,0.08)}
    </style>
</head>
<body>
  <header class="appbar">
    <h1>Plazas de Garaje ‚Äî An√°lisis interactivo</h1>
    <div class="meta">Interactivo ‚Äî selecciona, filtra y comparte</div>
  </header>

  <div class="container">
    <!-- Simple tab bar to avoid long scrolling -->
    <div id="tabBar" style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
      <button class="tabBtn" data-tab="principal">Principal</button>
      <button class="tabBtn" data-tab="basic">Tabla b√°sica</button>
      <button class="tabBtn" data-tab="guia">üó∫Ô∏è Gu√≠a visita</button>
      <button class="tabBtn" data-tab="original">ORIGINAL</button>
      <button class="tabBtn" data-tab="gastos">Gastos Totales</button>
      <button class="tabBtn" data-tab="agente">Agente</button>
    </div>
    <p class="hint">Selecciona hasta 3 plazas para crear un lote. Usa el control de ordenaci√≥n o haz clic en el encabezado de la tabla. Pulsa "Compartir vista" para obtener una URL con selecci√≥n/orden.</p>

    <!-- Gu√≠a r√°pida para visitas presenciales -->
    <section id="guiaCard" style="margin-top:12px;padding:16px;border-radius:8px;background:#fff;border:1px solid #d0e8ff">
      <h3 style="margin:0 0 12px 0;color:#0066cc">üó∫Ô∏è Gu√≠a R√°pida de Visita</h3>
      <div style="background:#f0f9ff;padding:12px;border-radius:8px;margin-bottom:12px">
        <strong style="color:#0066cc">üìã Checklist en Terreno:</strong>
        <ul style="margin:8px 0;padding-left:20px;line-height:1.8">
          <li>üìè <strong>Mide</strong> largo √ó ancho (verifica metros reales vs anunciados)</li>
          <li>üöó <strong>Prueba entrada/salida</strong> con tu coche (radio de giro)</li>
          <li>üèóÔ∏è <strong>Observa columnas/obst√°culos</strong> que dificulten maniobras</li>
          <li>üí° <strong>Iluminaci√≥n</strong> y ventilaci√≥n del s√≥tano</li>
          <li>üíß <strong>Humedad/filtraciones</strong> en paredes y techo</li>
          <li>üîí <strong>Acceso y seguridad</strong> (puerta autom√°tica, rampa estado)</li>
          <li>üìç <strong>Distancia al ascensor</strong> y facilidad de carga/descarga</li>
          <li>üö∞ <strong>Tuber√≠as</strong> o instalaciones que reduzcan altura √∫til</li>
        </ul>
      </div>
      <div style="background:#fff9e6;padding:12px;border-radius:8px;margin-bottom:12px">
        <strong style="color:#d97706">üí∞ Estrategia de Negociaci√≥n:</strong>
        <ul style="margin:8px 0;padding-left:20px;line-height:1.8">
          <li>üéØ <strong>Objetivo:</strong> Todas las plazas a ‚â§218,29 ‚Ç¨/m¬≤ (plaza 401 como referencia)</li>
          <li>üìâ <strong>Reducci√≥n m√≠nima:</strong> 4.000 ‚Ç¨ sobre precio de venta</li>
          <li>üîç <strong>Argumentos:</strong>
            <ul style="margin-top:4px">
              <li>Plazas 300/301 est√°n a 10.500‚Ç¨ (usa como referencia baja)</li>
              <li>P.S.3 (s√≥tano 3) debe ser m√°s barato que P.S.1 y P.S.2</li>
              <li>Plazas similares tienen precios muy diferentes (inconsistencia)</li>
            </ul>
          </li>
          <li>üíµ <strong>Oferta ejemplo Plaza 401:</strong> Precio 13.000‚Ç¨ ‚Üí Tu oferta 9.000‚Ç¨</li>
          <li>‚ö° <strong>As bajo la manga:</strong> Pago r√°pido/contado si aceptan tu precio</li>
        </ul>
      </div>
      <div style="background:#f0fdf4;padding:12px;border-radius:8px">
        <strong style="color:#059669">üéØ Mejores Oportunidades (‚Ç¨/m¬≤ m√°s bajo):</strong>
        <ol style="margin:8px 0;padding-left:20px;line-height:1.8">
          <li><strong>Plaza 368</strong>: 62,97 m¬≤ √ó 13.000‚Ç¨ = 206,46 ‚Ç¨/m¬≤ ‚Äî Muy grande</li>
          <li><strong>Plaza 336</strong>: 61,20 m¬≤ √ó 13.000‚Ç¨ = 212,42 ‚Ç¨/m¬≤ ‚Äî Muy grande</li>
          <li><strong>Plazas 320 y 356</strong>: ~50 m¬≤ √ó 11.000‚Ç¨ = 220,71 ‚Ç¨/m¬≤ ‚≠ê <span style="color:#059669;font-weight:700">MEJOR RELACI√ìN</span></li>
          <li><strong>Plazas 300/301</strong>: ~28 m¬≤ √ó 10.500‚Ç¨ ‚Äî M√°s baratas absolutas</li>
        </ol>
        <div style="margin-top:8px;padding:8px;background:#fff;border-radius:6px;border:1px solid #d1fae5">
          üí° <strong>Tip:</strong> Usa el bot√≥n flotante üöó para consultar cualquier plaza al instante mientras visitas.
        </div>
      </div>
    </section>

    <!-- Tabla b√°sica: compacta para m√≥viles -->
    <section id="basicCard" style="margin-top:12px;padding:12px;border-radius:8px;background:#fff;border:1px solid #eef3ff">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
        <div>
          <strong>Tabla b√°sica</strong>
          <div class="meta" style="margin-top:6px">Versi√≥n compacta: s√≥lo N.¬∫ Plaza, Precio, OFERTA y Diferencia. Ideal para m√≥viles.</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="btnShowBasic" class="primary">Ver tabla b√°sica</button>
          <button id="btnHideBasic" style="display:none">Ocultar</button>
        </div>
      </div>

      <div id="basicTableWrap" style="margin-top:12px;display:none">
        <table id="basicTable" style="width:100%;border-collapse:collapse">
          <thead>
            <tr style="background:#fbfdff;border-bottom:1px solid #eef3ff">
              <th style="padding:8px">N.¬∫ Plaza</th>
              <th style="padding:8px">Precio</th>
              <th style="padding:8px">OFERTA</th>
              <th style="padding:8px">Diferencia</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <div class="controls">
    <label>Ordenar por:
      <select id="sortField">
        <option value="metros">Metros</option>
        <option value="precio">Precio</option>
  <option value="oferta">OFERTA</option>
        <option value="ahorro">Ahorro (descuento propuesto)</option>
      </select>
    </label>

    <label>Orden:
      <select id="sortOrder">
        <option value="desc">Descendente</option>
        <option value="asc">Ascendente</option>
      </select>
    </label>

    <button id="recommend" class="primary">Recomendar mejor lote</button>
  <label>N: <input id="recommendN" type="number" min="1" value="3" style="width:60px"></label>
  <label style="margin-left:8px"><input type="checkbox" id="hideSold"> Ocultar vendidas</label>
    <div class="controls-right">
      <button id="share">Compartir vista</button>
      <button id="exportCsv">Exportar CSV</button>
      <button id="exportSel">Exportar selecci√≥n (JSON)</button>
      <button id="importSel">Importar selecci√≥n (JSON)</button>
    </div>
    <input type="file" id="importFile" accept="application/json" style="display:none">
    <div style="margin-left:auto">
      <span class="badge" id="selectedCount">Seleccionadas: 0</span>
      <span class="badge" id="totalSavings" style="margin-left:8px">Ahorro total: 0 ‚Ç¨</span>
      <span class="badge" id="recommendedSavings" style="margin-left:8px">Ahorro recomendado: 0 ‚Ç¨</span>
    </div>
  </div>

  <div style="margin-top:12px">
    <label>Buscar plaza por n√∫mero: <input id="searchPlaza" type="number" min="1" placeholder="Ej: 320" style="width:100px"></label>
    <button id="btnSearch">Buscar</button>
    <button id="btnAddToLot">A√±adir al lote</button>
    <span id="searchResult" style="margin-left:12px;color:#222"></span>
  </div>

  <!-- Chat-like agent panel (inside tabs) -->
  <section id="agentPanel" style="margin-top:18px;border:1px solid #e6eefb;padding:12px;border-radius:8px;background:#fbfcff">
    <h2 style="margin:0 0 8px 0">Agente "APACAAQUITUCOCHE" ‚Äî Preg√∫ntame por una plaza</h2>
    <div id="chat" style="height:220px;overflow:auto;border:1px solid #eef3ff;padding:10px;background:#fff;border-radius:8px"></div>
    <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
      <input id="agentInput" placeholder="Escribe: 'plaza 401' o 'APACAAQUITUCOCHE marcar 401 favorito'" style="flex:1;padding:10px;border-radius:8px;border:1px solid #e6eefb">
      <button id="agentSend" class="primary">Enviar</button>
      <button id="agentClear">Limpiar</button>
    </div>
  </section>

  <!-- Floating chat button (mobile-optimized) -->
  <button id="floatingChatBtn" style="position:fixed;bottom:20px;right:20px;width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#0066cc,#7c3aed);border:none;box-shadow:0 4px 20px rgba(124,58,237,0.4);cursor:pointer;z-index:9999;display:flex;align-items:center;justify-content:center;font-size:28px;transition:transform 0.2s,box-shadow 0.2s" title="Abrir asistente de negociaci√≥n">
    üöó
  </button>

  <!-- Floating chat window -->
  <div id="floatingChatWindow" style="position:fixed;bottom:90px;right:20px;width:90vw;max-width:400px;height:500px;background:#fff;border-radius:16px;box-shadow:0 8px 40px rgba(0,0,0,0.15);z-index:10000;display:none;flex-direction:column;overflow:hidden">
    <div style="background:linear-gradient(90deg,#0066cc,#7c3aed);color:#fff;padding:16px;display:flex;justify-content:space-between;align-items:center">
      <div style="display:flex;align-items:center;gap:8px">
        <span style="font-size:24px">üöó</span>
        <strong>Asistente Negociaci√≥n</strong>
      </div>
      <button id="closeChatBtn" style="background:rgba(255,255,255,0.2);border:none;color:#fff;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center">√ó</button>
    </div>
    <div id="floatingChat" style="flex:1;overflow:auto;padding:12px;background:#f9fbff"></div>
    <div style="padding:12px;border-top:1px solid #e6eefb;background:#fff;display:flex;gap:8px">
      <input id="floatingAgentInput" placeholder="Ej: plaza 401 o calculame..." style="flex:1;padding:12px;border-radius:8px;border:1px solid #e6eefb;font-size:16px">
      <button id="floatingAgentSend" style="padding:12px 20px;border-radius:8px;background:linear-gradient(90deg,#0066cc,#7c3aed);color:#fff;border:none;cursor:pointer;font-weight:700">Enviar</button>
    </div>
  </div>

  <div class="actions">
    <strong>Seleccionadas (m√°x 3):</strong>
    <span id="selectedList">‚Äî</span>
    <button id="clear">Limpiar selecci√≥n</button>
  </div>

  <table id="table">
    <thead>
      <tr>
        <th></th>
  <th data-key="plaza">N¬∫ PLAZA <span class="sort-arrow"><span class="arrow asc" data-order="asc">‚ñ≤</span><span class="arrow desc" data-order="desc">‚ñº</span></span></th>
  <th data-key="precio">PRECIO REAL (‚Ç¨/m¬≤) <span class="sort-arrow"><span class="arrow asc" data-order="asc">‚ñ≤</span><span class="arrow desc" data-order="desc">‚ñº</span></span></th>
  <th data-key="ubicacion">UBICACI√ìN <span class="sort-arrow"><span class="arrow asc" data-order="asc">‚ñ≤</span><span class="arrow desc" data-order="desc">‚ñº</span></span></th>
  <th data-key="metros">METROS <span class="sort-arrow"><span class="arrow asc" data-order="asc">‚ñ≤</span><span class="arrow desc" data-order="desc">‚ñº</span></span></th>
  <th data-key="oferta">OFERTA (‚Ç¨) <span class="sort-arrow"><span class="arrow asc" data-order="asc">‚ñ≤</span><span class="arrow desc" data-order="desc">‚ñº</span></span></th>
  <th data-key="ahorro">Ahorro (‚Ç¨) <span class="sort-arrow"><span class="arrow asc" data-order="asc">‚ñ≤</span><span class="arrow desc" data-order="desc">‚ñº</span></span></th>
        <th>Acciones</th>
      </tr>
      <tr id="filtersRow">
        <th></th>
        <th><input data-filter="plaza" style="width:100%" placeholder="filtrar"></th>
        <th><input data-filter="precio" style="width:100%" placeholder="filtrar"></th>
        <th><input data-filter="ubicacion" style="width:100%" placeholder="filtrar"></th>
        <th><input data-filter="metros" style="width:100%" placeholder="filtrar"></th>
        <th></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- ORIGINAL backup table (keeps UR/REGISTRAL and full raw data) -->
  <section id="originalPanel" style="margin-top:12px;padding:12px;border-radius:8px;background:#fff;border:1px solid #ffeedd">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div>
        <strong>ORIGINAL (backup)</strong>
        <div class="meta">Copia con la columna UR/REGISTRAL y los datos crudos. Visible bajo demanda.</div>
      </div>
      <div style="display:flex;gap:8px">
        <button id="btnShowOriginal">Ver ORIGINAL</button>
        <button id="btnHideOriginal" style="display:none">Ocultar</button>
      </div>
    </div>
    <div id="originalWrap" style="margin-top:10px;display:none;overflow:auto">
      <table id="originalTable" style="width:100%;border-collapse:collapse">
        <thead>
          <tr style="background:#fff7f0;border-bottom:1px solid #ffeedd">
            <th style="padding:8px">UR/REGISTRAL</th>
            <th style="padding:8px">N.¬∫ Plaza</th>
            <th style="padding:8px">Precio</th>
            <th style="padding:8px">OFERTA</th>
            <th style="padding:8px">Diferencia</th>
            <th style="padding:8px">Ubicaci√≥n</th>
            <th style="padding:8px">Metros</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <script>
    const DATA_URL = './plazas.json'
    let plazas = []
    let selected = new Set()

    function fmtMoney(n){ return n.toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2}) + ' ‚Ç¨' }

    // Compute the OFERTA for a plaza according to rules:
    // - baseline: reduce at least 4.000 ‚Ç¨ -> candidate1 = precio - 4000
    // - if precio/m¬≤ > TARGET_PER_M2 then candidate2 = TARGET_PER_M2 * metros
    // - oferta = min(candidate1, candidate2_when_applicable), floored at 0
    const TARGET_PER_M2 = 218.29
    function ofertaFor(p){
      const precio = Number(p.precio) || 0
      const metros = Number(p.metros) || 0
      const cand1 = precio - 4000
      if(metros > 0){
        const pricePerM2 = precio / metros
        if(pricePerM2 > TARGET_PER_M2){
          const cand2 = TARGET_PER_M2 * metros
          return Math.max(0, Math.min(cand1, cand2))
        }
      }
      return Math.max(0, cand1)
    }

    // Parse a money string like "11.300,00" or "9000" into a Number (euros)
    function parseMoneyStr(s){
      if(typeof s === 'number') return s
      if(!s) return 0
      const str = String(s).replace(/‚Ç¨/g,'').trim()
      // remove thousand separators (.) and replace decimal comma with dot
      const cleaned = str.replace(/\./g,'').replace(/,/g,'.').replace(/\s+/g,'')
      const v = Number(cleaned)
      return isNaN(v) ? 0 : v
    }

    function render(){
      const tbody = document.querySelector('#table tbody')
      tbody.innerHTML = ''
        plazas.forEach(p=>{
            const oferta = ofertaFor(p)
        const tr = document.createElement('tr')
        if(selected.has(p.plaza)) tr.classList.add('selected')
          const ahorro = +(p.precio - oferta)
        const favs = JSON.parse(localStorage.getItem('plazas_favs')||'{}')
        const notes = JSON.parse(localStorage.getItem('plazas_notes')||'{}')
        const sold = JSON.parse(localStorage.getItem('plazas_sold')||'{}')
        const isFav = !!favs[p.plaza]
        const isSold = !!sold[p.plaza]
        tr.innerHTML = `
          <td><input type="checkbox" data-plaza="${p.plaza}" ${selected.has(p.plaza)?'checked':''}></td>
          <td>${p.plaza} ${notes[p.plaza] ? `<div style="font-size:0.8rem;color:#666">${notes[p.plaza].slice(0,60)}${notes[p.plaza].length>60? '‚Ä¶':''}</div>` : ''}</td>
          <td>${p.precio_str}${p.metros ? `<div style="font-size:0.85rem;color:var(--muted)">${fmtMoney(p.precio / p.metros)}/m¬≤</div>` : ''}</td>
          <td>${p.ubicacion}</td>
          <td>${p.metros}</td>
          <td>
              ${fmtMoney(oferta)}
            ${p.metros ? `<div style="font-size:0.85rem;color:var(--muted)">${fmtMoney(oferta / p.metros)}/m¬≤</div>` : ''}
          </td>
          <td style="color:${ahorro>=0? '#0a0' : '#d00'}">${fmtMoney(ahorro)}</td>
          <td style="white-space:nowrap">
            <button class="fav" data-plaza="${p.plaza}" title="Favorito">${isFav? '‚òÖ' : '‚òÜ'}</button>
            <button class="note" data-plaza="${p.plaza}" title="Notas">üìù</button>
            <button class="sold" data-plaza="${p.plaza}" title="Marcar vendida">${isSold? 'üö´' : '‚úî'}</button>
          </td>
        `
        if(isSold) tr.classList.add('sold')
        tbody.appendChild(tr)
      })
      attachCheckboxHandlers()
      updateSelectedUI()
      attachActionHandlers()
    }

    // Gastos Totales section (separate table)
    function renderGastosTable(){
      // create or reuse container
      let wrap = document.getElementById('gastosWrap')
      if(!wrap){
        const sec = document.createElement('section')
        sec.id = 'gastosSection'
        sec.style = 'margin-top:14px;padding:12px;border-radius:8px;background:#fff;border:1px solid #eef8f6'
        sec.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Gastos Totales</strong><div class="meta">ITP y estimaci√≥n de notar√≠a/gestor√≠a por plaza</div></div>
          </div>
          <div id="gastosWrap" style="margin-top:10px;overflow:auto">
            <table id="gastosTable" style="width:100%;border-collapse:collapse">
              <thead>
                <tr style="background:#f7fffb;border-bottom:1px solid #e6f7ee">
                  <th style="padding:8px">N.¬∫ Plaza</th>
                  <th style="padding:8px">ITP (8%)</th>
                  <th style="padding:8px">Notar√≠a (min-max)</th>
                  <th style="padding:8px">Gestor√≠a (min-max)</th>
                  <th style="padding:8px">Total (min)</th>
                  <th style="padding:8px">Total (max)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        `
        document.querySelector('.container').appendChild(sec)
        wrap = document.getElementById('gastosWrap')
      }
      const tbody = document.querySelector('#gastosTable tbody')
      tbody.innerHTML = ''
      plazas.forEach(p=>{
        const oferta = ofertaFor(p)
          const itp = oferta * 0.08
        const notMin = 400, notMax = 600
        const gestMin = 100, gestMax = 150
        const totalMin = itp + notMin + gestMin
        const totalMax = itp + notMax + gestMax
        const tr = document.createElement('tr')
        tr.innerHTML = `
          <td style="padding:8px;border-bottom:1px solid #f1fbf7">${p.plaza}</td>
          <td style="padding:8px;border-bottom:1px solid #f1fbf7">${fmtMoney(itp)}</td>
          <td style="padding:8px;border-bottom:1px solid #f1fbf7">${fmtMoney(notMin)} ‚Äì ${fmtMoney(notMax)}</td>
          <td style="padding:8px;border-bottom:1px solid #f1fbf7">${fmtMoney(gestMin)} ‚Äì ${fmtMoney(gestMax)}</td>
          <td style="padding:8px;border-bottom:1px solid #f1fbf7">${fmtMoney(totalMin)}</td>
          <td style="padding:8px;border-bottom:1px solid #f1fbf7">${fmtMoney(totalMax)}</td>
        `
        tbody.appendChild(tr)
      })
    }

      // Render ORIGINAL backup table by loading the markdown source `plazas-garaje.md`.
      // If the fetch fails, fall back to the in-memory `plazas` dataset.
      function parseMarkdownTable(md){
        const lines = md.split(/\r?\n/)
        // find first table header line (starts with '|')
        let start = -1
        for(let i=0;i<lines.length;i++){ if(lines[i].trim().startsWith('|')){ start = i; break } }
        if(start === -1) return null
        // collect table lines until a non-pipe or empty line after header
        const tableLines = []
        for(let i=start;i<lines.length;i++){
          const L = lines[i]
          if(!L.trim().startsWith('|')) break
          tableLines.push(L.trim())
        }
        if(tableLines.length < 2) return null
        // header is first line, separator is second
        const header = tableLines[0].split('|').map(s=>s.trim()).filter(Boolean)
        const rows = []
        for(let i=2;i<tableLines.length;i++){
          const cells = tableLines[i].split('|').map(s=>s.trim()).filter(Boolean)
          if(cells.length === 0) continue
          rows.push(cells)
        }
        return { header, rows }
      }

      function renderOriginalTableFromMd(md){
        const parsed = parseMarkdownTable(md)
        const wrap = document.getElementById('originalWrap')
        if(!parsed){ wrap.innerHTML = '<div class="meta">No se ha encontrado la tabla en plazas-garaje.md</div>'; return }
        // build HTML table
        let html = '<div style="overflow:auto"><table style="width:100%;border-collapse:collapse">'
        html += '<thead><tr style="background:#fff7f0;border-bottom:1px solid #ffeedd">'
        parsed.header.forEach(h=> html += '<th style="padding:8px">' + h + '</th>')
        html += '</tr></thead><tbody>'
        parsed.rows.forEach(r=>{
          html += '<tr>'
          r.forEach(c=> html += '<td style="padding:8px;border-bottom:1px solid #fff7f0">' + c + '</td>')
          html += '</tr>'
        })
        html += '</tbody></table></div>'
        wrap.innerHTML = html
      }

      function renderOriginalTable(){
        // Prefer the markdown source as authoritative original backup
        fetch('./plazas-garaje.md').then(r=>{
          if(!r.ok) throw new Error('md fetch failed')
          return r.text()
        }).then(md=>{
          renderOriginalTableFromMd(md)
        }).catch(err=>{
          // fallback: render from plazas[] (legacy behavior)
          const tbody = document.querySelector('#originalTable tbody')
          tbody.innerHTML = ''
          plazas.forEach(p=>{
            const tr = document.createElement('tr')
            tr.innerHTML = `
              <td style="padding:8px;border-bottom:1px solid #fff7f0">${p.ur || ''}</td>
              <td style="padding:8px;border-bottom:1px solid #fff7f0">${p.plaza}</td>
              <td style="padding:8px;border-bottom:1px solid #fff7f0">${p.precio_str}</td>
              <td style="padding:8px;border-bottom:1px solid #fff7f0">${fmtMoney(p.estimado)}</td>
              <td style="padding:8px;border-bottom:1px solid #fff7f0;color:${(p.estimado - p.precio)>=0? '#0a0':'#d00'}">${fmtMoney(p.estimado - p.precio)}</td>
              <td style="padding:8px;border-bottom:1px solid #fff7f0">${p.ubicacion}</td>
              <td style="padding:8px;border-bottom:1px solid #fff7f0">${p.metros}</td>
            `
            tbody.appendChild(tr)
          })
        })
      }

      // ORIGINAL panel handlers
      document.getElementById('btnShowOriginal').addEventListener('click', ()=>{
        document.getElementById('originalWrap').style.display = 'block'
        document.getElementById('btnShowOriginal').style.display = 'none'
        document.getElementById('btnHideOriginal').style.display = 'inline-block'
        renderOriginalTable()
        // scroll the panel into view
        document.getElementById('originalPanel').scrollIntoView({behavior:'smooth',block:'center'})
      })
      document.getElementById('btnHideOriginal').addEventListener('click', ()=>{
        document.getElementById('originalWrap').style.display = 'none'
        document.getElementById('btnShowOriginal').style.display = 'inline-block'
        document.getElementById('btnHideOriginal').style.display = 'none'
      })

    // Render a compact, mobile-friendly basic table with only plaza, precio, estimado, diferencia
    function renderBasicTable(){
      const wrap = document.getElementById('basicTableWrap')
      const tbody = document.querySelector('#basicTable tbody')
      tbody.innerHTML = ''
    plazas.forEach(p=>{
      const tr = document.createElement('tr')
      const oferta = ofertaFor(p)
      const ofertaPerM2 = (p.metros ? fmtMoney(oferta / p.metros) + '/m¬≤' : '')
          tr.innerHTML = `
            <td style="padding:8px;border-bottom:1px solid #f3f6ff">${p.plaza}</td>
            <td style="padding:8px;border-bottom:1px solid #f3f6ff">${p.precio_str}${p.metros ? `<div style="font-size:0.85rem;color:var(--muted)">${fmtMoney(p.precio / p.metros)}/m¬≤</div>` : ''}</td>
            <td style="padding:8px;border-bottom:1px solid #f3f6ff">${fmtMoney(oferta)}${ofertaPerM2 ? `<div style="font-size:0.85rem;color:var(--muted)">${ofertaPerM2}</div>` : ''}</td>
            <td style="padding:8px;border-bottom:1px solid #f3f6ff;color:${(p.precio - oferta)>=0? '#0a0':'#d00'}">${fmtMoney(p.precio - oferta)}</td>
          `
        tbody.appendChild(tr)
      })
    }

    function attachActionHandlers(){
      document.querySelectorAll('button.fav').forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.dataset.plaza
          const favs = JSON.parse(localStorage.getItem('plazas_favs')||'{}')
          if(favs[id]) delete favs[id]
          else favs[id] = true
          localStorage.setItem('plazas_favs', JSON.stringify(favs))
          render()
        }
      })
      document.querySelectorAll('button.note').forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.dataset.plaza
          const notes = JSON.parse(localStorage.getItem('plazas_notes')||'{}')
          const current = notes[id] || ''
          const v = prompt('Notas para la plaza ' + id, current)
          if(v === null) return
          if(v === '') { delete notes[id] }
          else notes[id] = v
          localStorage.setItem('plazas_notes', JSON.stringify(notes))
          render()
        }
      })
      document.querySelectorAll('button.sold').forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.dataset.plaza
          const sold = JSON.parse(localStorage.getItem('plazas_sold')||'{}')
          if(sold[id]) delete sold[id]
          else sold[id] = true
          localStorage.setItem('plazas_sold', JSON.stringify(sold))
          render()
        }
      })
    }

    // Filters
    document.querySelectorAll('#filtersRow input[data-filter]').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        applyFilters()
      })
    })
    function applyFilters(){
      const filters = {}
      document.querySelectorAll('#filtersRow input[data-filter]').forEach(inp=>{ if(inp.value) filters[inp.dataset.filter]=inp.value.toLowerCase() })
      const hideSold = document.getElementById('hideSold')?.checked
      document.querySelectorAll('#table tbody tr').forEach(tr=>{
        let visible = true
        const cells = tr.querySelectorAll('td')
        // updated column indexes after adding ITP column
  const m = { plaza:1, precio:2, ubicacion:3, metros:4 }
        for(const k in filters){
          const idx = m[k]
          if(idx===undefined) continue
          const text = (cells[idx]?.textContent||'').toLowerCase()
          if(!text.includes(filters[k])) { visible=false; break }
        }
        if(hideSold && tr.classList.contains('sold')) visible = false
        tr.style.display = visible ? '' : 'none'
      })
    }

    function attachCheckboxHandlers(){
      document.querySelectorAll('input[type=checkbox][data-plaza]').forEach(cb=>{
        cb.onchange = e=>{
          const n = Number(cb.dataset.plaza)
          if(cb.checked) selected.add(n)
          else selected.delete(n)
          // persist selection
          localStorage.setItem('plazas_selected', JSON.stringify(Array.from(selected)))
          updateSelectedUI()
        }
      })
    }

    function updateSelectedUI(){
      document.getElementById('selectedCount').textContent = 'Seleccionadas: ' + selected.size
      const listSpan = document.getElementById('selectedList')
      if(selected.size===0) listSpan.textContent = '‚Äî'
      else listSpan.textContent = Array.from(selected).join(', ')
      // update total savings for current selection
  const ssum = Array.from(selected).map(n=>{ const p = plazas.find(x=>x.plaza===n); return p ? (p.precio - ofertaFor(p)) : 0 }).reduce((a,b)=>a+b,0)
      document.getElementById('totalSavings').textContent = 'Ahorro total: ' + fmtMoney(ssum)
    }

    function sortBy(field,order){
      plazas.sort((a,b)=>{
        let va, vb
    if(field==='ahorro'){ va = (a.precio - ofertaFor(a)); vb = (b.precio - ofertaFor(b)) }
  else if(field==='oferta'){ va = ofertaFor(a); vb = ofertaFor(b) }
  else if(field==='itp'){ va = a.precio * 0.08; vb = b.precio * 0.08 }
  else if(field==='gastos_min'){ va = (a.precio * 0.08) + 400 + 100; vb = (b.precio * 0.08) + 400 + 100 }
  else if(field==='gastos_max'){ va = (a.precio * 0.08) + 600 + 150; vb = (b.precio * 0.08) + 600 + 150 }
        else { va = a[field]; vb = b[field] }
        if(va < vb) return order==='asc'? -1 : 1
        if(va > vb) return order==='asc'? 1 : -1
        return 0
      })
      render()
    }

    function applyUrlParams(){
      const params = new URLSearchParams(window.location.search)
      const s = params.get('sort')
      const o = params.get('order')
      const sel = params.get('selected')
      if(s) document.getElementById('sortField').value = s
      if(o) document.getElementById('sortOrder').value = o
      if(sel){ sel.split(',').map(x=>Number(x)).forEach(n=>{ if(!isNaN(n)) selected.add(n) }) }
    }

    function shareUrl(){
      const params = new URLSearchParams()
      params.set('sort', document.getElementById('sortField').value)
      params.set('order', document.getElementById('sortOrder').value)
      if(selected.size>0) params.set('selected', Array.from(selected).join(','))
      const url = location.origin + location.pathname + '?' + params.toString()
      navigator.clipboard?.writeText(url).then(()=>alert('URL copiada al portapapeles:\n'+url)).catch(()=>prompt('Copia esta URL:', url))
    }

    function exportCsv(){
  const rows = [['UR/REGISTRAL','N¬∫ PLAZA','PRECIO','PRECIO/m¬≤','UBICACI√ìN','METROS','OFERTA','OFERTA/m¬≤','Ahorro','ITP(8%)','Gastos m√≠n','Gastos m√°x']]
      plazas.forEach(p=>{
        const oferta = ofertaFor(p)
        const ahorro = (p.precio - oferta).toFixed(2)
        const itp = (oferta * 0.08).toFixed(2)
        const gmin = ((oferta * 0.08) + 400 + 100).toFixed(2)
        const gmax = ((oferta * 0.08) + 600 + 150).toFixed(2)
        const precioPerM2 = (p.metros ? (p.precio / p.metros).toFixed(2) : '')
        const ofertaPerM2 = (p.metros ? (oferta / p.metros).toFixed(2) : '')
        rows.push([p.ur,p.plaza,p.precio_str,precioPerM2,p.ubicacion,p.metros,oferta.toFixed(2),ofertaPerM2,ahorro,itp,gmin,gmax])
      })
      const csv = rows.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n')
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}), url = URL.createObjectURL(blob)
      const a = document.createElement('a'); a.href = url; a.download = 'plazas-estimaciones.csv'; a.click(); URL.revokeObjectURL(url)
    }

    // Events
    document.getElementById('sortField').onchange = ()=>{ sortBy(document.getElementById('sortField').value, document.getElementById('sortOrder').value); updateUrlState() }
    document.getElementById('sortOrder').onchange = ()=>{ sortBy(document.getElementById('sortField').value, document.getElementById('sortOrder').value); updateUrlState() }
    document.getElementById('recommend').onclick = ()=>{
      // seleccionar top N por ahorro (estimado - precio) desc, respetando vendidas
      const sold = JSON.parse(localStorage.getItem('plazas_sold')||'{}')
      const N = Math.max(1, Number(document.getElementById('recommendN').value) || 3)
      const candidates = plazas.filter(p=>!sold[p.plaza])
  candidates.sort((a,b)=> ((b.precio - ofertaFor(b)) - (a.precio - ofertaFor(a))))
      const top = candidates.slice(0,N).map(p=>p.plaza)
      selected = new Set(top)
      localStorage.setItem('plazas_selected', JSON.stringify(Array.from(selected)))
      render(); updateUrlState()
      // update recommended savings badge
  const recSavings = top.map(n=>{ const p = plazas.find(x=>x.plaza===n); return p ? (p.precio - ofertaFor(p)) : 0 }).reduce((a,b)=>a+b,0)
      document.getElementById('recommendedSavings').textContent = 'Ahorro recomendado: ' + fmtMoney(recSavings)
    }
    document.getElementById('share').onclick = shareUrl
    document.getElementById('clear').onclick = ()=>{ selected.clear(); render(); updateUrlState() }
    document.getElementById('exportCsv').onclick = exportCsv
    document.getElementById('exportSel').onclick = ()=>{
      const data = JSON.stringify(Array.from(selected))
      const blob = new Blob([data],{type:'application/json'}); const url = URL.createObjectURL(blob)
      const a = document.createElement('a'); a.href = url; a.download = 'seleccion-plazas.json'; a.click(); URL.revokeObjectURL(url)
    }
    document.getElementById('importSel').onclick = ()=> document.getElementById('importFile').click()
    document.getElementById('importFile').onchange = (e)=>{
      const f = e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = ()=>{
        try{ const arr = JSON.parse(reader.result); if(Array.isArray(arr)){ selected = new Set(arr.map(Number)); localStorage.setItem('plazas_selected', JSON.stringify(Array.from(selected))); render(); updateUrlState() } else alert('JSON inv√°lido') }
        catch(err){ alert('Error leyendo JSON: '+err.message) }
      }; reader.readAsText(f)
    }
    document.getElementById('btnSearch').onclick = ()=>{
      const v = Number(document.getElementById('searchPlaza').value)
      if(!v) { alert('Introduce un n√∫mero de plaza v√°lido'); return }
      const r = lookupPlaza(v)
      const target = document.getElementById('searchResult')
      if(!r) { target.textContent = 'Plaza no encontrada'; target.style.color = '#d00'; return }
      target.style.color = '#060'
      const oferta = ofertaFor(r)
      const ofertaPerM2 = r.metros ? fmtMoney(oferta / r.metros) + '/m¬≤' : 'N/D'
      target.textContent = `Plaza ${r.plaza}: ${r.precio_str} ‚Äî ${r.ubicacion} ‚Äî ${r.metros} m¬≤ ‚Äî OFERTA: ${fmtMoney(oferta)} (${ofertaPerM2}) ‚Äî Ahorro: ${fmtMoney(r.precio - oferta)}`
    }
    document.getElementById('btnAddToLot').onclick = ()=>{
      const v = Number(document.getElementById('searchPlaza').value)
      if(!v) { alert('Introduce un n√∫mero de plaza v√°lido'); return }
      const r = lookupPlaza(v)
      if(!r) { alert('Plaza no encontrada'); return }
      selected.add(r.plaza)
      localStorage.setItem('plazas_selected', JSON.stringify(Array.from(selected)))
      render(); updateUrlState()
    }

    function lookupPlaza(n){
      return plazas.find(p=>p.plaza === Number(n))
    }

    // Header click sorting: toggle sort on any th[data-key]
    function clearHeaderSortClasses(){
      document.querySelectorAll('th[data-key]').forEach(t=>{ t.classList.remove('sorted','asc','desc') })
      // reset arrow emphasis
      document.querySelectorAll('th[data-key] .sort-arrow .arrow').forEach(a=>a.style.opacity='0.35')
    }

    function setHeaderArrow(key,order){
      clearHeaderSortClasses()
      const th = document.querySelector('th[data-key="'+key+'"]')
      if(!th) return
      th.classList.add('sorted')
      th.classList.add(order === 'asc' ? 'asc' : 'desc')
      // highlight arrows
      const ascEl = th.querySelector('.sort-arrow .arrow.asc')
      const descEl = th.querySelector('.sort-arrow .arrow.desc')
      if(ascEl) ascEl.style.opacity = order === 'asc' ? '0.95' : '0.35'
      if(descEl) descEl.style.opacity = order === 'desc' ? '0.95' : '0.35'
      // sync selects
      document.getElementById('sortField').value = key
      document.getElementById('sortOrder').value = order
      // persist last sort
      localStorage.setItem('plazas_last_sort', JSON.stringify({field:key,order:order}))
    }

    // header click toggles order
    document.querySelectorAll('th[data-key]').forEach(th=>{
      th.addEventListener('click', (ev)=>{
        // if clicked on explicit arrow, that will be handled separately
        const key = th.dataset.key
        const last = JSON.parse(localStorage.getItem('plazas_last_sort')||'null') || {}
        let currentField = last.field || document.getElementById('sortField').value
        let currentOrder = last.order || document.getElementById('sortOrder').value
        if(currentField === key) currentOrder = currentOrder === 'asc' ? 'desc' : 'asc'
        else currentOrder = 'desc'
        setHeaderArrow(key,currentOrder)
        sortBy(key,currentOrder)
        updateUrlState()
      })
      // arrows inside header: clicking a specific arrow sets that order explicitly
      const ascEl = th.querySelector('.sort-arrow .arrow.asc')
      const descEl = th.querySelector('.sort-arrow .arrow.desc')
      if(ascEl){ ascEl.addEventListener('click', (e)=>{ e.stopPropagation(); const key = th.dataset.key; setHeaderArrow(key,'asc'); sortBy(key,'asc'); updateUrlState() }) }
      if(descEl){ descEl.addEventListener('click', (e)=>{ e.stopPropagation(); const key = th.dataset.key; setHeaderArrow(key,'desc'); sortBy(key,'desc'); updateUrlState() }) }
    })

    function updateUrlState(){
      const params = new URLSearchParams()
      params.set('sort', document.getElementById('sortField').value)
      params.set('order', document.getElementById('sortOrder').value)
      if(selected.size>0) params.set('selected', Array.from(selected).join(','))
      const newurl = window.location.pathname + '?' + params.toString()
      history.replaceState(null,'',newurl)
    }

    // Init
    fetch(DATA_URL).then(r=>r.json()).then(data=>{
      plazas = data
      // restore selection from localStorage
      const saved = JSON.parse(localStorage.getItem('plazas_selected')||'[]')
      if(Array.isArray(saved)) saved.forEach(n=>selected.add(Number(n)))
      applyUrlParams()
      // restore last sort from localStorage if present
      const last = JSON.parse(localStorage.getItem('plazas_last_sort')||'null')
      const field = last?.field || document.getElementById('sortField').value
      const order = last?.order || document.getElementById('sortOrder').value
      document.getElementById('sortField').value = field
      document.getElementById('sortOrder').value = order
      sortBy(field, order)
      setHeaderArrow(field, order)
      // render basic table for mobile/quick view
      renderBasicTable()
      // render Gastos Totales section
      renderGastosTable()
    })

    // Basic table show/hide handlers
    document.getElementById('btnShowBasic').addEventListener('click', ()=>{
      document.getElementById('basicTableWrap').style.display = 'block'
      document.getElementById('btnShowBasic').style.display = 'none'
      document.getElementById('btnHideBasic').style.display = 'inline-block'
      // scroll to the basic table for mobile
      document.getElementById('basicTable').scrollIntoView({behavior:'smooth',block:'center'})
    })
    document.getElementById('btnHideBasic').addEventListener('click', ()=>{
      document.getElementById('basicTableWrap').style.display = 'none'
      document.getElementById('btnShowBasic').style.display = 'inline-block'
      document.getElementById('btnHideBasic').style.display = 'none'
    })

    // --- Agent logic: chat-like interface ---
    function appendChat(who, html){
      const chat = document.getElementById('chat')
      const el = document.createElement('div')
      el.style.marginBottom = '8px'
      el.innerHTML = `<strong>${who}:</strong> <span>${html}</span>`
      chat.appendChild(el)
      chat.scrollTop = chat.scrollHeight
    }

    function agentReplyForPlaza(n){
      const p = lookupPlaza(n)
      if(!p) return `No encuentro la plaza ${n}.`
  const oferta = ofertaFor(p)
      const ahorro = p.precio - oferta
      // extra fields: metros, sotano if present in ubicacion detection
      const sotanoMatch = (p.ubicacion||'').match(/sotano\s*(\d+)/i) || (p.ubicacion||'').match(/s√≥tano\s*(\d+)/i)
      const sotano = sotanoMatch ? sotanoMatch[1] : 'N/D'
      const por_m2 = p.precio && p.metros ? (p.precio / p.metros) : null
      const por_m2_estim = oferta && p.metros ? (oferta / p.metros) : null
      let out = ''
      out += `<div>Plaza <strong>${p.plaza}</strong> ‚Äî ${p.ubicacion || ''} ‚Äî ${p.metros} m¬≤</div>`
      const ofertaPerM2 = oferta && p.metros ? (oferta / p.metros) : null
      out += `<div>Precio mercado: <strong>${p.precio_str}</strong> ‚Äî <strong>OFERTA (tu oferta):</strong> <strong>${fmtMoney(oferta)}</strong> ‚Äî Ahorro propuesto: <strong style="color:${ahorro>=0? '#0a0':'#d00'}">${fmtMoney(ahorro)}</strong></div>`
      if(p.metros) out += `<div>Precio/m¬≤: ${por_m2 ? fmtMoney(por_m2) : 'N/D'} ‚Äî Oferta/m¬≤: ${ofertaPerM2 ? fmtMoney(ofertaPerM2) : 'N/D'}</div>`
      out += `<div>S√≥tano: <strong>${sotano}</strong></div>`
      out += `<div style="margin-top:6px;color:var(--muted)">Estrategia: reducir como m√≠nimo 4.000 ‚Ç¨ sobre el precio listado; la OFERTA mostrada aplica ese descuento m√≠nimo.</div>`
  // cost breakdown (approx) computed on the OFERTA (what you pay)
  const itp = oferta * 0.08
    const notMin = 400, notMax = 600
    const gestMin = 100, gestMax = 150
    const totalMin = itp + notMin + gestMin
    const totalMax = itp + notMax + gestMax
  out += `<div style="margin-top:8px"><strong>Gastos aproximados (compra 2¬™ mano):</strong></div>`
  out += `<div class="meta">üí∏ <span title="Impuesto de Transmisiones Patrimoniales (8%)">ITP (8%):</span> <strong>${fmtMoney(itp)}</strong></div>`
  out += `<div class="meta">üìú <span title="Gastos de notar√≠a y registro estimados">Notar√≠a + registro:</span> <strong>${fmtMoney(notMin)} ‚Äì ${fmtMoney(notMax)}</strong></div>`
  out += `<div class="meta">üßæ <span title="Gestor√≠a: tramitaci√≥n administrativa (opcional)">Gestor√≠a (opcional):</span> <strong>${fmtMoney(gestMin)} ‚Äì ${fmtMoney(gestMax)}</strong></div>`
  out += `<div style="margin-top:6px">üî¢ <strong>Total aproximado:</strong> ${fmtMoney(totalMin)} ‚Äì ${fmtMoney(totalMax)}</div>`
      // actions
      out += `<div style="margin-top:6px"><button data-action="fav" data-plaza="${p.plaza}">Marcar favorito</button> <button data-action="sold" data-plaza="${p.plaza}">Marcar vendida</button></div>`
      return out
    }

    function processAgentInput(text){
      const t = (text||'').trim()
      if(!t) return
      appendChat('T√∫', t.replace(/</g,'&lt;'))
      // detect calculation requests like:
      // "calculame el precio del m2 si la plaza 401 vale 9.000‚Ç¨"
      const calcMatch = t.match(/\bcalculame(?:|\s+el)?\s+precio\s+del\s+m2\s+si\s+la\s+plaza\s*(\d+)\s*vale\s*([\d\.,\s]+)\s*‚Ç¨?/i)
                     || t.match(/\bcalculame.*precio.*m2.*plaza\s*(\d+).*vale\s*([\d\.,\s]+)\s*‚Ç¨?/i)
      if(calcMatch){
        const id = Number(calcMatch[1])
        const priceStr = calcMatch[2]
        const p = lookupPlaza(id)
        if(!p){ appendChat('APACAAQUITUCOCHE', `No encuentro la plaza ${id}.`) ; return }
        const priceNum = parseMoneyStr(priceStr)
        const metros = Number(p.metros) || 0
        const perM2 = metros ? (priceNum / metros) : null
        const ofertaFromGivenPrice = ofertaFor({precio: priceNum, metros: metros})
        const itp = ofertaFromGivenPrice * 0.08
        const notMin = 400, notMax = 600, gestMin = 100, gestMax = 150
        const totalMin = itp + notMin + gestMin
        const totalMax = itp + notMax + gestMax
        let out = ''
        out += `<div>Si la plaza <strong>${id}</strong> se pide <strong>${fmtMoney(priceNum)}</strong>:</div>`
        if(perM2) out += `<div>Precio/m¬≤ resultante: <strong>${fmtMoney(perM2)}</strong> ‚Äî objetivo: <strong>${fmtMoney(TARGET_PER_M2)}</strong>/m¬≤</div>`
        if(perM2 && perM2 > TARGET_PER_M2) out += `<div style="color:#b95">Nota: el precio por m¬≤ propuesto excede el objetivo ${fmtMoney(TARGET_PER_M2)}/m¬≤; podr√≠as intentar igualar a ${fmtMoney(TARGET_PER_M2 * metros)}</div>`
        out += `<div style="margin-top:6px">OFERTA recomendada (aplicando reglas): <strong>${fmtMoney(ofertaFromGivenPrice)}</strong> ‚Äî Ahorro frente al precio pedido: <strong>${fmtMoney(priceNum - ofertaFromGivenPrice)}</strong></div>`
        out += `<div class="meta">Gastos aprox (sobre OFERTA): ITP ${fmtMoney(itp)} ‚Äî Notar√≠a ${fmtMoney(notMin)}‚Äì${fmtMoney(notMax)} ‚Äî Gestor√≠a ${fmtMoney(gestMin)}‚Äì${fmtMoney(gestMax)}</div>`
        out += `<div style="margin-top:6px"><strong>Total aprox:</strong> ${fmtMoney(totalMin)} ‚Äì ${fmtMoney(totalMax)}</div>`
        appendChat('APACAAQUITUCOCHE', out)
        return
      }
      // detect commands: 'plaza 401' or just a number
      const plazaMatch = t.match(/\bplaza\s*(\d+)\b/i) || t.match(/^\s*(\d+)\s*$/)
      // detect APACAAQUITUCOCHE commands like: APACAAQUITUCOCHE marcar 401 favorito
      const special = t.match(/APACAAQUITUCOCHE\s+([^\n]+)/i)
      if(special){
        const cmd = special[1].trim()
        // e.g. 'marcar 401 favorito' or 'marcar 401 vendida'
        const m = cmd.match(/marcar\s*(\d+)\s*(favorito|vendida|vendido|vende)/i)
        if(m){
          const id = Number(m[1])
          const what = m[2].toLowerCase()
          if(/favorito/.test(what)){
            const favs = JSON.parse(localStorage.getItem('plazas_favs')||'{}')
            favs[id] = true
            localStorage.setItem('plazas_favs', JSON.stringify(favs))
            render()
            appendChat('APACAAQUITUCOCHE', `He marcado la plaza ${id} como favorito (por petici√≥n APACAAQUITUCOCHE).`)
            return
          }
          if(/vend|vendida|vende/.test(what)){
            const sold = JSON.parse(localStorage.getItem('plazas_sold')||'{}')
            sold[id] = true
            localStorage.setItem('plazas_sold', JSON.stringify(sold))
            render()
            appendChat('APACAAQUITUCOCHE', `He marcado la plaza ${id} como VENDIDA (por petici√≥n APACAAQUITUCOCHE).`)
            return
          }
        }
        appendChat('APACAAQUITUCOCHE', `Comando APACAAQUITUCOCHE no reconocido: ${cmd.replace(/</g,'&lt;')}`)
        return
      }
      if(plazaMatch){
        const id = Number(plazaMatch[1])
        const reply = agentReplyForPlaza(id)
        appendChat('APACAAQUITUCOCHE', reply)
        // attach event handlers for inline buttons
        setTimeout(()=>attachAgentButtons(),50)
        return
      }
      // fallback: try to detect a plain number
      const numOnly = t.match(/^(\d{2,4})$/)
      if(numOnly){
        const id = Number(numOnly[1])
        const reply = agentReplyForPlaza(id)
        appendChat('APACAAQUITUCOCHE', reply)
        setTimeout(()=>attachAgentButtons(),50)
        return
      }
      
      // detect TOP command
      if(/\b(top|mejores|chollos?|oportunidades?|recomend)/i.test(t)){
        let out = '<div style="margin-bottom:12px"><strong style="color:#059669">üèÜ TOP 10 Mejores Oportunidades</strong></div>'
        
        const ranked = plazas.map(p=>{
          const oferta = ofertaFor(p)
          const ahorro = p.precio - oferta
          const pricePerM2 = p.metros ? (p.precio / p.metros) : 999
          const ofertaPerM2 = p.metros ? (oferta / p.metros) : 999
          return {...p, oferta, ahorro, pricePerM2, ofertaPerM2}
        }).sort((a,b)=>{
          if(Math.abs(a.pricePerM2 - b.pricePerM2) > 10) return a.pricePerM2 - b.pricePerM2
          return b.ahorro - a.ahorro
        }).slice(0,10)

        out += '<ol style="margin:8px 0;padding-left:20px;line-height:1.9">'
        ranked.forEach((p,i)=>{
          const badge = i < 3 ? (i===0 ? 'ü•á' : i===1 ? 'ü•à' : 'ü•â') : `${i+1}.`
          const highlight = i < 3 ? 'style="background:#f0fdf4;padding:8px;border-radius:6px;margin:4px 0"' : 'style="margin:4px 0"'
          out += `<li ${highlight}><strong>Plaza ${p.plaza}</strong> (${p.ubicacion})<br>`
          out += `üìè ${p.metros} m¬≤ ‚Äî üí∞ ${p.precio_str} (${fmtMoney(p.pricePerM2)}/m¬≤)<br>`
          out += `<span style="color:#059669">üíµ OFERTA: ${fmtMoney(p.oferta)} (${fmtMoney(p.ofertaPerM2)}/m¬≤)</span><br>`
          out += `üìâ Ahorro: <strong>${fmtMoney(p.ahorro)}</strong>`
          if(p.pricePerM2 <= TARGET_PER_M2) out += ` ‚úÖ <span style="color:#059669;font-size:0.9em">Ya en objetivo</span>`
          out += '</li>'
        })
        out += '</ol>'
        
        out += '<div style="margin-top:12px;padding:10px;background:#fff9e6;border-radius:8px;border:1px solid #fbbf24">'
        out += 'üí° <strong>Estrategia:</strong> Visita las 3 primeras (ü•áü•àü•â) y negocia agresivamente. '
        out += 'Si necesitas m√°s espacio, plazas 368/336 son enormes y ya tienen buen ‚Ç¨/m¬≤.'
        out += '</div>'

        appendChat('APACAAQUITUCOCHE', out)
        return
      }
      
      appendChat('APACAAQUITUCOCHE', 'No he entendido. Pide por ejemplo "plaza 401", "top 10" o usa "APACAAQUITUCOCHE marcar 401 favorito"')
    }

    function attachAgentButtons(){
      document.querySelectorAll('#chat button[data-action]').forEach(b=>{
        if(b.dataset.bound) return;
        b.dataset.bound = '1';
        b.addEventListener('click', e=>{
          const a = b.dataset.action
          const id = Number(b.dataset.plaza)
          if(a === 'fav'){
            const favs = JSON.parse(localStorage.getItem('plazas_favs')||'{}')
            favs[id] = true
            localStorage.setItem('plazas_favs', JSON.stringify(favs))
            render();
            appendChat('APACAAQUITUCOCHE', `Plaza ${id} marcada como favorito.`)
          } else if(a === 'sold'){
            const sold = JSON.parse(localStorage.getItem('plazas_sold')||'{}')
            sold[id] = true
            localStorage.setItem('plazas_sold', JSON.stringify(sold))
            render();
            appendChat('APACAAQUITUCOCHE', `Plaza ${id} marcada como VENDIDA.`);
          }
        })
      })
    }

    document.getElementById('agentSend').addEventListener('click', ()=>{
      const val = document.getElementById('agentInput').value
      document.getElementById('agentInput').value = ''
      processAgentInput(val)
    })
    document.getElementById('agentInput').addEventListener('keydown', e=>{ if(e.key === 'Enter') { e.preventDefault(); document.getElementById('agentSend').click() } })
    document.getElementById('agentClear').addEventListener('click', ()=>{ document.getElementById('chat').innerHTML = '' })

    // --- Floating chat window logic ---
    const floatingBtn = document.getElementById('floatingChatBtn')
    const floatingWindow = document.getElementById('floatingChatWindow')
    const closeBtn = document.getElementById('closeChatBtn')
    const floatingChatDiv = document.getElementById('floatingChat')
    const floatingInput = document.getElementById('floatingAgentInput')
    const floatingSend = document.getElementById('floatingAgentSend')

    function appendFloatingChat(who, html){
      const el = document.createElement('div')
      el.style.marginBottom = '12px'
      el.style.padding = '10px'
      el.style.borderRadius = '8px'
      el.style.background = who === 'T√∫' ? '#e8f0ff' : '#fff'
      el.style.border = '1px solid ' + (who === 'T√∫' ? '#d0e1ff' : '#e6eefb')
      el.innerHTML = `<strong style="color:${who === 'T√∫' ? '#0066cc' : '#7c3aed'}">${who}:</strong> <div style="margin-top:4px">${html}</div>`
      floatingChatDiv.appendChild(el)
      floatingChatDiv.scrollTop = floatingChatDiv.scrollHeight
    }

    function processFloatingInput(text){
      const t = (text||'').trim()
      if(!t) return
      appendFloatingChat('T√∫', t.replace(/</g,'&lt;'))
      
      // detect calculation requests
      const calcMatch = t.match(/\bcalculame(?:|\s+el)?\s+precio\s+del\s+m2\s+si\s+la\s+plaza\s*(\d+)\s*vale\s*([\d\.,\s]+)\s*‚Ç¨?/i)
                     || t.match(/\bcalculame.*precio.*m2.*plaza\s*(\d+).*vale\s*([\d\.,\s]+)\s*‚Ç¨?/i)
      if(calcMatch){
        const id = Number(calcMatch[1])
        const priceStr = calcMatch[2]
        const p = lookupPlaza(id)
        if(!p){ appendFloatingChat('üöó Asistente', `No encuentro la plaza ${id}.`) ; return }
        const priceNum = parseMoneyStr(priceStr)
        const metros = Number(p.metros) || 0
        const perM2 = metros ? (priceNum / metros) : null
        const ofertaFromGivenPrice = ofertaFor({precio: priceNum, metros: metros})
        const itp = ofertaFromGivenPrice * 0.08
        const notMin = 400, notMax = 600, gestMin = 100, gestMax = 150
        const totalMin = itp + notMin + gestMin
        const totalMax = itp + notMax + gestMax
        let out = ''
        out += `<div><strong>Plaza ${id}</strong> a <strong>${fmtMoney(priceNum)}</strong>:</div>`
        if(perM2) out += `<div>Precio/m¬≤: <strong>${fmtMoney(perM2)}</strong> vs objetivo <strong>${fmtMoney(TARGET_PER_M2)}</strong></div>`
        if(perM2 && perM2 > TARGET_PER_M2) out += `<div style="color:#d97706;margin-top:4px">‚ö†Ô∏è Excede objetivo. Intenta ofrecer ${fmtMoney(TARGET_PER_M2 * metros)}</div>`
        out += `<div style="margin-top:8px">üí∞ <strong>OFERTA recomendada:</strong> ${fmtMoney(ofertaFromGivenPrice)}</div>`
        out += `<div>üìâ Ahorro: ${fmtMoney(priceNum - ofertaFromGivenPrice)}</div>`
        out += `<div style="margin-top:8px;font-size:0.9em;color:#666">Gastos: ITP ${fmtMoney(itp)} + Notar√≠a ${fmtMoney(notMin)}-${fmtMoney(notMax)} + Gestor√≠a ${fmtMoney(gestMin)}-${fmtMoney(gestMax)}</div>`
        out += `<div style="margin-top:4px"><strong>Total aprox:</strong> ${fmtMoney(totalMin)} - ${fmtMoney(totalMax)}</div>`
        appendFloatingChat('üöó Asistente', out)
        setTimeout(()=>attachFloatingButtons(),50)
        return
      }

      // detect plaza lookup
      const plazaMatch = t.match(/\bplaza\s*(\d+)\b/i) || t.match(/^\s*(\d+)\s*$/)
      if(plazaMatch){
        const id = Number(plazaMatch[1])
        const p = lookupPlaza(id)
        if(!p){ appendFloatingChat('üöó Asistente', `No encuentro la plaza ${id}.`); return }
        const oferta = ofertaFor(p)
        const ahorro = p.precio - oferta
        const perM2 = p.precio && p.metros ? (p.precio / p.metros) : null
        const ofertaPerM2 = oferta && p.metros ? (oferta / p.metros) : null
        let out = ''
        out += `<div><strong>Plaza ${p.plaza}</strong> ‚Äî ${p.ubicacion} ‚Äî ${p.metros} m¬≤</div>`
        out += `<div style="margin-top:6px">üíµ Precio: <strong>${p.precio_str}</strong> (${perM2 ? fmtMoney(perM2)+'/m¬≤' : 'N/D'})</div>`
        out += `<div>üí∞ <strong>OFERTA:</strong> ${fmtMoney(oferta)} (${ofertaPerM2 ? fmtMoney(ofertaPerM2)+'/m¬≤' : 'N/D'})</div>`
        out += `<div>üìâ Ahorro: <strong style="color:#059669">${fmtMoney(ahorro)}</strong></div>`
        const itp = oferta * 0.08
        const totalMin = itp + 400 + 100
        const totalMax = itp + 600 + 150
        out += `<div style="margin-top:8px;font-size:0.9em;color:#666">Gastos aprox: ${fmtMoney(totalMin)} - ${fmtMoney(totalMax)}</div>`
        out += `<div style="margin-top:8px"><button data-action="fav" data-plaza="${p.plaza}" style="padding:6px 12px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer;margin-right:6px">‚≠ê Favorito</button> <button data-action="sold" data-plaza="${p.plaza}" style="padding:6px 12px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer">üö´ Vendida</button></div>`
        appendFloatingChat('üöó Asistente', out)
        setTimeout(()=>attachFloatingButtons(),50)
        return
      }

      // detect APACAAQUITUCOCHE commands
      const special = t.match(/APACAAQUITUCOCHE\s+([^\n]+)/i)
      if(special){
        const cmd = special[1].trim()
        const m = cmd.match(/marcar\s*(\d+)\s*(favorito|vendida|vendido|vende)/i)
        if(m){
          const id = Number(m[1])
          const what = m[2].toLowerCase()
          if(/favorito/.test(what)){
            const favs = JSON.parse(localStorage.getItem('plazas_favs')||'{}')
            favs[id] = true
            localStorage.setItem('plazas_favs', JSON.stringify(favs))
            render()
            appendFloatingChat('üöó Asistente', `‚úÖ Plaza ${id} marcada como favorita.`)
            return
          }
          if(/vend|vendida|vende/.test(what)){
            const sold = JSON.parse(localStorage.getItem('plazas_sold')||'{}')
            sold[id] = true
            localStorage.setItem('plazas_sold', JSON.stringify(sold))
            render()
            appendFloatingChat('üöó Asistente', `‚úÖ Plaza ${id} marcada como VENDIDA.`)
            return
          }
        }
        appendFloatingChat('üöó Asistente', `No reconozco ese comando: ${cmd.replace(/</g,'&lt;')}`)
        return
      }

      // detect TOP command
      if(/\b(top|mejores|chollos?|oportunidades?|recomend)/i.test(t)){
        let out = '<div style="margin-bottom:12px"><strong style="color:#059669">üèÜ TOP 10 Mejores Oportunidades</strong></div>'
        
        // Calculate all plazas with oferta and sort by best value (lowest price/m¬≤ and highest savings)
        const ranked = plazas.map(p=>{
          const oferta = ofertaFor(p)
          const ahorro = p.precio - oferta
          const pricePerM2 = p.metros ? (p.precio / p.metros) : 999
          const ofertaPerM2 = p.metros ? (oferta / p.metros) : 999
          return {...p, oferta, ahorro, pricePerM2, ofertaPerM2}
        }).sort((a,b)=>{
          // Priority: 1) lowest price/m¬≤ 2) highest absolute savings
          if(Math.abs(a.pricePerM2 - b.pricePerM2) > 10) return a.pricePerM2 - b.pricePerM2
          return b.ahorro - a.ahorro
        }).slice(0,10)

        out += '<ol style="margin:8px 0;padding-left:20px;line-height:1.9">'
        ranked.forEach((p,i)=>{
          const badge = i < 3 ? (i===0 ? 'ü•á' : i===1 ? 'ü•à' : 'ü•â') : `${i+1}.`
          const highlight = i < 3 ? 'style="background:#f0fdf4;padding:8px;border-radius:6px;margin:4px 0"' : 'style="margin:4px 0"'
          out += `<li ${highlight}><strong>Plaza ${p.plaza}</strong> (${p.ubicacion})<br>`
          out += `üìè ${p.metros} m¬≤ ‚Äî üí∞ ${p.precio_str} (${fmtMoney(p.pricePerM2)}/m¬≤)<br>`
          out += `<span style="color:#059669">üíµ OFERTA: ${fmtMoney(p.oferta)} (${fmtMoney(p.ofertaPerM2)}/m¬≤)</span><br>`
          out += `üìâ Ahorro: <strong>${fmtMoney(p.ahorro)}</strong>`
          if(p.pricePerM2 <= TARGET_PER_M2) out += ` ‚úÖ <span style="color:#059669;font-size:0.9em">Ya en objetivo</span>`
          out += '</li>'
        })
        out += '</ol>'
        
        out += '<div style="margin-top:12px;padding:10px;background:#fff9e6;border-radius:8px;border:1px solid #fbbf24">'
        out += 'üí° <strong>Estrategia:</strong> Visita las 3 primeras (ü•áü•àü•â) y negocia agresivamente. '
        out += 'Si necesitas m√°s espacio, plazas 368/336 son enormes y ya tienen buen ‚Ç¨/m¬≤.'
        out += '</div>'

        appendFloatingChat('üöó Asistente', out)
        return
      }

      // fallback
      appendFloatingChat('üöó Asistente', `Escribe:<br>‚Ä¢ "plaza 401" para ver detalles<br>‚Ä¢ "top" o "mejores" para ver TOP 10 chollos<br>‚Ä¢ "calculame el precio del m2 si la plaza 401 vale 9000‚Ç¨"<br>‚Ä¢ "APACAAQUITUCOCHE marcar 401 favorito"`)
    }

    function attachFloatingButtons(){
      document.querySelectorAll('#floatingChat button[data-action]').forEach(b=>{
        if(b.dataset.bound) return
        b.dataset.bound = '1'
        b.addEventListener('click', ()=>{
          const a = b.dataset.action
          const id = Number(b.dataset.plaza)
          if(a === 'fav'){
            const favs = JSON.parse(localStorage.getItem('plazas_favs')||'{}')
            favs[id] = true
            localStorage.setItem('plazas_favs', JSON.stringify(favs))
            render()
            appendFloatingChat('üöó Asistente', `‚úÖ Plaza ${id} marcada como favorita.`)
          } else if(a === 'sold'){
            const sold = JSON.parse(localStorage.getItem('plazas_sold')||'{}')
            sold[id] = true
            localStorage.setItem('plazas_sold', JSON.stringify(sold))
            render()
            appendFloatingChat('üöó Asistente', `‚úÖ Plaza ${id} marcada como VENDIDA.`)
          }
        })
      })
    }

    floatingBtn.addEventListener('click', ()=>{
      floatingWindow.style.display = 'flex'
      floatingBtn.style.display = 'none'
    })

    closeBtn.addEventListener('click', ()=>{
      floatingWindow.style.display = 'none'
      floatingBtn.style.display = 'flex'
    })

    floatingSend.addEventListener('click', ()=>{
      const val = floatingInput.value
      floatingInput.value = ''
      processFloatingInput(val)
    })

    floatingInput.addEventListener('keydown', e=>{
      if(e.key === 'Enter'){
        e.preventDefault()
        floatingSend.click()
      }
    })

    // Add hover effect to floating button
    floatingBtn.addEventListener('mouseenter', ()=>{ floatingBtn.style.transform = 'scale(1.1)'; floatingBtn.style.boxShadow = '0 6px 30px rgba(124,58,237,0.6)' })
    floatingBtn.addEventListener('mouseleave', ()=>{ floatingBtn.style.transform = 'scale(1)'; floatingBtn.style.boxShadow = '0 4px 20px rgba(124,58,237,0.4)' })

    // --- Tab bar: switch visible panels to avoid long scrolling ---
    function showTab(name){
      const toShow = {
        principal: ['.controls','#table','.actions'],
        basic: ['#basicCard'],
        guia: ['#guiaCard'],
        original: ['#originalPanel'],
        gastos: ['#gastosSection'],
        agente: ['#agentPanel']
      }[name] || ['.controls','#table','.actions']
      // All candidate selectors we may hide/show
      const allSelectors = ['.controls','#table','.actions','#basicCard','#guiaCard','#originalPanel','#gastosSection','#agentPanel']
      allSelectors.forEach(sel=>{
        document.querySelectorAll(sel).forEach(el=>{ el.style.display = 'none' })
      })
      toShow.forEach(sel=>{
        document.querySelectorAll(sel).forEach(el=>{ el.style.display = '' })
      })
      // ensure ORIGINAL button state is consistent
      document.querySelectorAll('#tabBar .tabBtn').forEach(b=>{ b.classList.toggle('active', b.dataset.tab===name) })
      // if showing gastos and it's not rendered yet, render it
      if(name==='gastos') setTimeout(()=>{ if(typeof renderGastosTable === 'function') renderGastosTable() },50)
    }

    document.querySelectorAll('#tabBar .tabBtn').forEach(b=>{
      b.addEventListener('click', ()=> showTab(b.dataset.tab))
    })
    // show principal by default
    showTab('principal')

  </script>
  </div>
</body>
</html>