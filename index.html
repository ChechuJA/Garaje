<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plazas Garaje — Análisis interactivo</title>
  <style>
    :root{
      --bg:#f3f6ff;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#0066cc;
      --accent-2: #7c3aed;
      --success:#0a8a3a;
      --danger:#d64545;
      --glass: rgba(255,255,255,0.6);
    }
    html,body{height:100%;margin:0}
    body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:1200px;margin:18px auto;padding:0 16px;background:linear-gradient(180deg,#e9f0ff 0%, #f9fbff 100%);color:#0f172a}
    header.appbar{display:flex;align-items:center;gap:12px;padding:18px;border-radius:12px;background:linear-gradient(90deg,var(--accent),var(--accent-2));box-shadow:0 8px 30px rgba(60,80,120,0.12);color:#fff;margin-bottom:18px}
    header.appbar h1{margin:0;font-size:1.2rem;font-weight:700}
    .container{background:var(--card);padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(20,30,60,0.03)}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .controls label, .controls select, .controls input {font-size:0.95rem}
    .badge{display:inline-block;padding:6px 12px;background:linear-gradient(90deg,#eef6ff,#e8f0ff);color:var(--accent);border-radius:999px;font-weight:700;border:1px solid rgba(3,102,204,0.08)}
    .actions{margin-top:12px}
    .hint{color:var(--muted);font-size:0.95rem}
    button{padding:8px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:linear-gradient(180deg,#fff,#fbfdff);cursor:pointer;box-shadow:0 2px 6px rgba(12,20,40,0.04)}
    button.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;border:none;box-shadow:0 6px 18px rgba(124,58,237,0.12)}
    button.positive{background:linear-gradient(90deg,#10b981,#059669);color:#fff;border:none}
    button.danger{background:linear-gradient(90deg,#f97316,#ef4444);color:#fff;border:none}
    button:hover{transform:translateY(-1px)}
    table{width:100%;border-collapse:collapse;margin-top:12px;border-radius:6px;overflow:hidden;box-shadow:0 4px 12px rgba(20,30,60,0.04)}
    th,td{padding:10px 12px;text-align:left}
    thead th{background:linear-gradient(180deg,#fff,#fbfdff);border-bottom:1px solid #eef3ff}
    tbody tr:nth-child(even){background:linear-gradient(90deg,#ffffff,#fbfbff)}
    tbody tr:hover{background:linear-gradient(90deg,#fffbe6,#f7fbff);transform:translateY(0);}
    tr.selected{background:linear-gradient(90deg,#f0fff4,#e9fff0)}
    tr.sold td{opacity:0.5;text-decoration:line-through}
    .meta{color:var(--muted);font-size:0.9rem}
    .controls-right{margin-left:auto;display:flex;gap:8px;align-items:center}
    @media (max-width:800px){
      .controls{flex-direction:column;align-items:stretch}
      header.appbar{flex-direction:column;align-items:flex-start}
    }
    /* sort arrows */
    th .sort-arrow{margin-left:6px;font-size:0.8em;opacity:0.6;display:inline-flex;flex-direction:column;line-height:0.8}
    th .sort-arrow .arrow{font-size:0.8em;opacity:0.35;padding:0 4px;cursor:pointer;display:inline-block}
    th.sorted .sort-arrow .arrow{opacity:0.9}
    th.sorted.asc .sort-arrow .arrow.asc{font-weight:700}
    th.sorted.desc .sort-arrow .arrow.desc{font-weight:700}
  </style>
    <style>
      /* compact action buttons */
      td button{border-radius:8px;padding:6px 8px;margin-right:6px;font-size:0.95rem;border:1px solid rgba(0,0,0,0.04)}
        td button.fav{background:linear-gradient(90deg,#fff8f0,#fff2f0);border:1px solid rgba(255,140,0,0.12)}
        td button.note{background:linear-gradient(90deg,#fffbf0,#fff9f0);border:1px solid rgba(250,204,21,0.08)}
        td button.sold{background:linear-gradient(90deg,#f8fafc,#fff);border:1px solid rgba(0,0,0,0.04)}
        td button.fav:hover{box-shadow:0 6px 16px rgba(255,140,0,0.08)}
    </style>
</head>
<body>
  <header class="appbar">
    <h1>Plazas de Garaje — Análisis interactivo</h1>
    <div class="meta">Interactivo — selecciona, filtra y comparte</div>
  </header>

  <div class="container">
    <p class="hint">Selecciona hasta 3 plazas para crear un lote. Usa el control de ordenación o haz clic en el encabezado de la tabla. Pulsa "Compartir vista" para obtener una URL con selección/orden.</p>

    <!-- Tabla básica: compacta para móviles -->
    <section id="basicCard" style="margin-top:12px;padding:12px;border-radius:8px;background:#fff;border:1px solid #eef3ff">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
        <div>
          <strong>Tabla básica</strong>
          <div class="meta" style="margin-top:6px">Versión compacta: sólo N.º Plaza, Precio, Estimado y Diferencia. Ideal para móviles.</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="btnShowBasic" class="primary">Ver tabla básica</button>
          <button id="btnHideBasic" style="display:none">Ocultar</button>
        </div>
      </div>

      <div id="basicTableWrap" style="margin-top:12px;display:none">
        <table id="basicTable" style="width:100%;border-collapse:collapse">
          <thead>
            <tr style="background:#fbfdff;border-bottom:1px solid #eef3ff">
              <th style="padding:8px">N.º Plaza</th>
              <th style="padding:8px">Precio</th>
              <th style="padding:8px">Estimado</th>
              <th style="padding:8px">Diferencia</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <div class="controls">
    <label>Ordenar por:
      <select id="sortField">
        <option value="metros">Metros</option>
        <option value="precio">Precio</option>
        <option value="ahorro">Ahorro (estimado - precio)</option>
      </select>
    </label>

    <label>Orden:
      <select id="sortOrder">
        <option value="desc">Descendente</option>
        <option value="asc">Ascendente</option>
      </select>
    </label>

    <button id="recommend" class="primary">Recomendar mejor lote</button>
  <label>N: <input id="recommendN" type="number" min="1" value="3" style="width:60px"></label>
  <label style="margin-left:8px"><input type="checkbox" id="hideSold"> Ocultar vendidas</label>
    <div class="controls-right">
      <button id="share">Compartir vista</button>
      <button id="exportCsv">Exportar CSV</button>
      <button id="exportSel">Exportar selección (JSON)</button>
      <button id="importSel">Importar selección (JSON)</button>
    </div>
    <input type="file" id="importFile" accept="application/json" style="display:none">
    <div style="margin-left:auto">
      <span class="badge" id="selectedCount">Seleccionadas: 0</span>
      <span class="badge" id="totalSavings" style="margin-left:8px">Ahorro total: 0 €</span>
      <span class="badge" id="recommendedSavings" style="margin-left:8px">Ahorro recomendado: 0 €</span>
    </div>
  </div>

  <div style="margin-top:12px">
    <label>Buscar plaza por número: <input id="searchPlaza" type="number" min="1" placeholder="Ej: 320" style="width:100px"></label>
    <button id="btnSearch">Buscar</button>
    <button id="btnAddToLot">Añadir al lote</button>
    <span id="searchResult" style="margin-left:12px;color:#222"></span>
  </div>

  <!-- Chat-like agent panel -->
  <section id="agentPanel" style="margin-top:18px;border:1px solid #e6eefb;padding:12px;border-radius:8px;background:#fbfcff">
    <h2 style="margin:0 0 8px 0">Agente "APACAAQUITUCOCHE" — Pregúntame por una plaza</h2>
    <div id="chat" style="height:220px;overflow:auto;border:1px solid #eef3ff;padding:10px;background:#fff;border-radius:8px"></div>
    <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
      <input id="agentInput" placeholder="Escribe: 'plaza 401' o 'APACAAQUITUCOCHE marcar 401 favorito'" style="flex:1;padding:10px;border-radius:8px;border:1px solid #e6eefb">
      <button id="agentSend" class="primary">Enviar</button>
      <button id="agentClear">Limpiar</button>
    </div>
  </section>

  <div class="actions">
    <strong>Seleccionadas (máx 3):</strong>
    <span id="selectedList">—</span>
    <button id="clear">Limpiar selección</button>
  </div>

  <table id="table">
    <thead>
      <tr>
        <th></th>
  <th data-key="plaza">Nº PLAZA <span class="sort-arrow"><span class="arrow asc" data-order="asc">▲</span><span class="arrow desc" data-order="desc">▼</span></span></th>
  <th data-key="precio">PRECIO <span class="sort-arrow"><span class="arrow asc" data-order="asc">▲</span><span class="arrow desc" data-order="desc">▼</span></span></th>
  <th data-key="itp">ITP (8%) <span class="sort-arrow"><span class="arrow asc" data-order="asc">▲</span><span class="arrow desc" data-order="desc">▼</span></span></th>
  <th data-key="ubicacion">UBICACIÓN <span class="sort-arrow"><span class="arrow asc" data-order="asc">▲</span><span class="arrow desc" data-order="desc">▼</span></span></th>
  <th data-key="metros">METROS <span class="sort-arrow"><span class="arrow asc" data-order="asc">▲</span><span class="arrow desc" data-order="desc">▼</span></span></th>
  <th data-key="estimado">Estimado (€) <span class="sort-arrow"><span class="arrow asc" data-order="asc">▲</span><span class="arrow desc" data-order="desc">▼</span></span></th>
  <th data-key="ahorro">Ahorro (€) <span class="sort-arrow"><span class="arrow asc" data-order="asc">▲</span><span class="arrow desc" data-order="desc">▼</span></span></th>
  <th data-key="gastos_min">Gastos mín (€) <span class="sort-arrow"><span class="arrow asc" data-order="asc">▲</span><span class="arrow desc" data-order="desc">▼</span></span></th>
  <th data-key="gastos_max">Gastos máx (€) <span class="sort-arrow"><span class="arrow asc" data-order="asc">▲</span><span class="arrow desc" data-order="desc">▼</span></span></th>
        <th>Acciones</th>
      </tr>
      <tr id="filtersRow">
        <th></th>
        <th><input data-filter="plaza" style="width:100%" placeholder="filtrar"></th>
        <th><input data-filter="precio" style="width:100%" placeholder="filtrar"></th>
        <th><input data-filter="itp" style="width:100%" placeholder="filtrar"></th>
        <th><input data-filter="ubicacion" style="width:100%" placeholder="filtrar"></th>
        <th><input data-filter="metros" style="width:100%" placeholder="filtrar"></th>
        <th></th>
        <th></th>
        <th></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- ORIGINAL backup table (keeps UR/REGISTRAL and full raw data) -->
  <section id="originalPanel" style="margin-top:12px;padding:12px;border-radius:8px;background:#fff;border:1px solid #ffeedd">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div>
        <strong>ORIGINAL (backup)</strong>
        <div class="meta">Copia con la columna UR/REGISTRAL y los datos crudos. Visible bajo demanda.</div>
      </div>
      <div style="display:flex;gap:8px">
        <button id="btnShowOriginal">Ver ORIGINAL</button>
        <button id="btnHideOriginal" style="display:none">Ocultar</button>
      </div>
    </div>
    <div id="originalWrap" style="margin-top:10px;display:none;overflow:auto">
      <table id="originalTable" style="width:100%;border-collapse:collapse">
        <thead>
          <tr style="background:#fff7f0;border-bottom:1px solid #ffeedd">
            <th style="padding:8px">UR/REGISTRAL</th>
            <th style="padding:8px">N.º Plaza</th>
            <th style="padding:8px">Precio</th>
            <th style="padding:8px">Estimado</th>
            <th style="padding:8px">Diferencia</th>
            <th style="padding:8px">Ubicación</th>
            <th style="padding:8px">Metros</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <script>
    const DATA_URL = './plazas.json'
    let plazas = []
    let selected = new Set()

    function fmtMoney(n){ return n.toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2}) + ' €' }

    function render(){
      const tbody = document.querySelector('#table tbody')
      tbody.innerHTML = ''
      plazas.forEach(p=>{
        const tr = document.createElement('tr')
        if(selected.has(p.plaza)) tr.classList.add('selected')
        const ahorro = +(p.estimado - p.precio)
        const favs = JSON.parse(localStorage.getItem('plazas_favs')||'{}')
        const notes = JSON.parse(localStorage.getItem('plazas_notes')||'{}')
        const sold = JSON.parse(localStorage.getItem('plazas_sold')||'{}')
        const isFav = !!favs[p.plaza]
        const isSold = !!sold[p.plaza]
        tr.innerHTML = `
          <td><input type="checkbox" data-plaza="${p.plaza}" ${selected.has(p.plaza)?'checked':''}></td>
          <td>${p.plaza} ${notes[p.plaza] ? `<div style="font-size:0.8rem;color:#666">${notes[p.plaza].slice(0,60)}${notes[p.plaza].length>60? '…':''}</div>` : ''}</td>
          <td>${p.precio_str}</td>
          <td>${fmtMoney(p.precio * 0.08)}</td>
          <td>${p.ubicacion}</td>
          <td>${p.metros}</td>
          <td>${fmtMoney(p.estimado)}</td>
          <td style="color:${ahorro>=0? '#0a0' : '#d00'}">${fmtMoney(ahorro)}</td>
          <td>${fmtMoney((p.precio * 0.08) + 400 + 100)}</td>
          <td>${fmtMoney((p.precio * 0.08) + 600 + 150)}</td>
          <td style="white-space:nowrap">
            <button class="fav" data-plaza="${p.plaza}" title="Favorito">${isFav? '★' : '☆'}</button>
            <button class="note" data-plaza="${p.plaza}" title="Notas">📝</button>
            <button class="sold" data-plaza="${p.plaza}" title="Marcar vendida">${isSold? '🚫' : '✔'}</button>
          </td>
        `
        if(isSold) tr.classList.add('sold')
        tbody.appendChild(tr)
      })
      attachCheckboxHandlers()
      updateSelectedUI()
      attachActionHandlers()
    }

      // Render ORIGINAL backup table (keeps UR and raw fields)
      function renderOriginalTable(){
        const tbody = document.querySelector('#originalTable tbody')
        tbody.innerHTML = ''
        plazas.forEach(p=>{
          const tr = document.createElement('tr')
          tr.innerHTML = `
            <td style="padding:8px;border-bottom:1px solid #fff7f0">${p.ur}</td>
            <td style="padding:8px;border-bottom:1px solid #fff7f0">${p.plaza}</td>
            <td style="padding:8px;border-bottom:1px solid #fff7f0">${p.precio_str}</td>
            <td style="padding:8px;border-bottom:1px solid #fff7f0">${fmtMoney(p.estimado)}</td>
            <td style="padding:8px;border-bottom:1px solid #fff7f0;color:${(p.estimado - p.precio)>=0? '#0a0':'#d00'}">${fmtMoney(p.estimado - p.precio)}</td>
            <td style="padding:8px;border-bottom:1px solid #fff7f0">${p.ubicacion}</td>
            <td style="padding:8px;border-bottom:1px solid #fff7f0">${p.metros}</td>
          `
          tbody.appendChild(tr)
        })
      }

      // ORIGINAL panel handlers
      document.getElementById('btnShowOriginal').addEventListener('click', ()=>{
        document.getElementById('originalWrap').style.display = 'block'
        document.getElementById('btnShowOriginal').style.display = 'none'
        document.getElementById('btnHideOriginal').style.display = 'inline-block'
        renderOriginalTable()
        document.getElementById('originalTable').scrollIntoView({behavior:'smooth',block:'center'})
      })
      document.getElementById('btnHideOriginal').addEventListener('click', ()=>{
        document.getElementById('originalWrap').style.display = 'none'
        document.getElementById('btnShowOriginal').style.display = 'inline-block'
        document.getElementById('btnHideOriginal').style.display = 'none'
      })

    // Render a compact, mobile-friendly basic table with only plaza, precio, estimado, diferencia
    function renderBasicTable(){
      const wrap = document.getElementById('basicTableWrap')
      const tbody = document.querySelector('#basicTable tbody')
      tbody.innerHTML = ''
      plazas.forEach(p=>{
        const tr = document.createElement('tr')
        tr.innerHTML = `
          <td style="padding:8px;border-bottom:1px solid #f3f6ff">${p.plaza}</td>
          <td style="padding:8px;border-bottom:1px solid #f3f6ff">${p.precio_str}</td>
          <td style="padding:8px;border-bottom:1px solid #f3f6ff">${fmtMoney(p.estimado)}</td>
          <td style="padding:8px;border-bottom:1px solid #f3f6ff;color:${(p.estimado - p.precio)>=0? '#0a0':'#d00'}">${fmtMoney(p.estimado - p.precio)}</td>
        `
        tbody.appendChild(tr)
      })
    }

    function attachActionHandlers(){
      document.querySelectorAll('button.fav').forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.dataset.plaza
          const favs = JSON.parse(localStorage.getItem('plazas_favs')||'{}')
          if(favs[id]) delete favs[id]
          else favs[id] = true
          localStorage.setItem('plazas_favs', JSON.stringify(favs))
          render()
        }
      })
      document.querySelectorAll('button.note').forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.dataset.plaza
          const notes = JSON.parse(localStorage.getItem('plazas_notes')||'{}')
          const current = notes[id] || ''
          const v = prompt('Notas para la plaza ' + id, current)
          if(v === null) return
          if(v === '') { delete notes[id] }
          else notes[id] = v
          localStorage.setItem('plazas_notes', JSON.stringify(notes))
          render()
        }
      })
      document.querySelectorAll('button.sold').forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.dataset.plaza
          const sold = JSON.parse(localStorage.getItem('plazas_sold')||'{}')
          if(sold[id]) delete sold[id]
          else sold[id] = true
          localStorage.setItem('plazas_sold', JSON.stringify(sold))
          render()
        }
      })
    }

    // Filters
    document.querySelectorAll('#filtersRow input[data-filter]').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        applyFilters()
      })
    })
    function applyFilters(){
      const filters = {}
      document.querySelectorAll('#filtersRow input[data-filter]').forEach(inp=>{ if(inp.value) filters[inp.dataset.filter]=inp.value.toLowerCase() })
      const hideSold = document.getElementById('hideSold')?.checked
      document.querySelectorAll('#table tbody tr').forEach(tr=>{
        let visible = true
        const cells = tr.querySelectorAll('td')
        // updated column indexes after adding ITP column
  const m = { plaza:1, precio:2, itp:3, ubicacion:4, metros:5 }
        for(const k in filters){
          const idx = m[k]
          if(idx===undefined) continue
          const text = (cells[idx]?.textContent||'').toLowerCase()
          if(!text.includes(filters[k])) { visible=false; break }
        }
        if(hideSold && tr.classList.contains('sold')) visible = false
        tr.style.display = visible ? '' : 'none'
      })
    }

    function attachCheckboxHandlers(){
      document.querySelectorAll('input[type=checkbox][data-plaza]').forEach(cb=>{
        cb.onchange = e=>{
          const n = Number(cb.dataset.plaza)
          if(cb.checked) selected.add(n)
          else selected.delete(n)
          // persist selection
          localStorage.setItem('plazas_selected', JSON.stringify(Array.from(selected)))
          updateSelectedUI()
        }
      })
    }

    function updateSelectedUI(){
      document.getElementById('selectedCount').textContent = 'Seleccionadas: ' + selected.size
      const listSpan = document.getElementById('selectedList')
      if(selected.size===0) listSpan.textContent = '—'
      else listSpan.textContent = Array.from(selected).join(', ')
      // update total savings for current selection
      const ssum = Array.from(selected).map(n=>{ const p = plazas.find(x=>x.plaza===n); return p ? (p.estimado - p.precio) : 0 }).reduce((a,b)=>a+b,0)
      document.getElementById('totalSavings').textContent = 'Ahorro total: ' + fmtMoney(ssum)
    }

    function sortBy(field,order){
      plazas.sort((a,b)=>{
        let va, vb
        if(field==='ahorro'){ va = (a.estimado - a.precio); vb = (b.estimado - b.precio) }
  else if(field==='itp'){ va = a.precio * 0.08; vb = b.precio * 0.08 }
  else if(field==='gastos_min'){ va = (a.precio * 0.08) + 400 + 100; vb = (b.precio * 0.08) + 400 + 100 }
  else if(field==='gastos_max'){ va = (a.precio * 0.08) + 600 + 150; vb = (b.precio * 0.08) + 600 + 150 }
        else { va = a[field]; vb = b[field] }
        if(va < vb) return order==='asc'? -1 : 1
        if(va > vb) return order==='asc'? 1 : -1
        return 0
      })
      render()
    }

    function applyUrlParams(){
      const params = new URLSearchParams(window.location.search)
      const s = params.get('sort')
      const o = params.get('order')
      const sel = params.get('selected')
      if(s) document.getElementById('sortField').value = s
      if(o) document.getElementById('sortOrder').value = o
      if(sel){ sel.split(',').map(x=>Number(x)).forEach(n=>{ if(!isNaN(n)) selected.add(n) }) }
    }

    function shareUrl(){
      const params = new URLSearchParams()
      params.set('sort', document.getElementById('sortField').value)
      params.set('order', document.getElementById('sortOrder').value)
      if(selected.size>0) params.set('selected', Array.from(selected).join(','))
      const url = location.origin + location.pathname + '?' + params.toString()
      navigator.clipboard?.writeText(url).then(()=>alert('URL copiada al portapapeles:\n'+url)).catch(()=>prompt('Copia esta URL:', url))
    }

    function exportCsv(){
      const rows = [['UR/REGISTRAL','Nº PLAZA','PRECIO','ITP(8%)','UBICACIÓN','METROS','Estimado','Ahorro','Gastos mín','Gastos máx']]
      plazas.forEach(p=>{
        const ahorro = (p.estimado - p.precio).toFixed(2)
        const itp = (p.precio * 0.08).toFixed(2)
        const gmin = ((p.precio * 0.08) + 400 + 100).toFixed(2)
        const gmax = ((p.precio * 0.08) + 600 + 150).toFixed(2)
        rows.push([p.ur,p.plaza,p.precio_str,itp,p.ubicacion,p.metros,p.estimado.toFixed(2),ahorro,gmin,gmax])
      })
      const csv = rows.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n')
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}), url = URL.createObjectURL(blob)
      const a = document.createElement('a'); a.href = url; a.download = 'plazas-estimaciones.csv'; a.click(); URL.revokeObjectURL(url)
    }

    // Events
    document.getElementById('sortField').onchange = ()=>{ sortBy(document.getElementById('sortField').value, document.getElementById('sortOrder').value); updateUrlState() }
    document.getElementById('sortOrder').onchange = ()=>{ sortBy(document.getElementById('sortField').value, document.getElementById('sortOrder').value); updateUrlState() }
    document.getElementById('recommend').onclick = ()=>{
      // seleccionar top N por ahorro (estimado - precio) desc, respetando vendidas
      const sold = JSON.parse(localStorage.getItem('plazas_sold')||'{}')
      const N = Math.max(1, Number(document.getElementById('recommendN').value) || 3)
      const candidates = plazas.filter(p=>!sold[p.plaza])
      candidates.sort((a,b)=> (b.estimado - b.precio) - (a.estimado - a.precio))
      const top = candidates.slice(0,N).map(p=>p.plaza)
      selected = new Set(top)
      localStorage.setItem('plazas_selected', JSON.stringify(Array.from(selected)))
      render(); updateUrlState()
      // update recommended savings badge
      const recSavings = top.map(n=>{ const p = plazas.find(x=>x.plaza===n); return p ? (p.estimado - p.precio) : 0 }).reduce((a,b)=>a+b,0)
      document.getElementById('recommendedSavings').textContent = 'Ahorro recomendado: ' + fmtMoney(recSavings)
    }
    document.getElementById('share').onclick = shareUrl
    document.getElementById('clear').onclick = ()=>{ selected.clear(); render(); updateUrlState() }
    document.getElementById('exportCsv').onclick = exportCsv
    document.getElementById('exportSel').onclick = ()=>{
      const data = JSON.stringify(Array.from(selected))
      const blob = new Blob([data],{type:'application/json'}); const url = URL.createObjectURL(blob)
      const a = document.createElement('a'); a.href = url; a.download = 'seleccion-plazas.json'; a.click(); URL.revokeObjectURL(url)
    }
    document.getElementById('importSel').onclick = ()=> document.getElementById('importFile').click()
    document.getElementById('importFile').onchange = (e)=>{
      const f = e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = ()=>{
        try{ const arr = JSON.parse(reader.result); if(Array.isArray(arr)){ selected = new Set(arr.map(Number)); localStorage.setItem('plazas_selected', JSON.stringify(Array.from(selected))); render(); updateUrlState() } else alert('JSON inválido') }
        catch(err){ alert('Error leyendo JSON: '+err.message) }
      }; reader.readAsText(f)
    }
    document.getElementById('btnSearch').onclick = ()=>{
      const v = Number(document.getElementById('searchPlaza').value)
      if(!v) { alert('Introduce un número de plaza válido'); return }
      const r = lookupPlaza(v)
      const target = document.getElementById('searchResult')
      if(!r) { target.textContent = 'Plaza no encontrada'; target.style.color = '#d00'; return }
      target.style.color = '#060'
      target.textContent = `Plaza ${r.plaza}: ${r.precio_str} — ${r.ubicacion} — ${r.metros} m² — Estimado: ${fmtMoney(r.estimado)} — Ahorro: ${fmtMoney(r.estimado - r.precio)}`
    }
    document.getElementById('btnAddToLot').onclick = ()=>{
      const v = Number(document.getElementById('searchPlaza').value)
      if(!v) { alert('Introduce un número de plaza válido'); return }
      const r = lookupPlaza(v)
      if(!r) { alert('Plaza no encontrada'); return }
      selected.add(r.plaza)
      localStorage.setItem('plazas_selected', JSON.stringify(Array.from(selected)))
      render(); updateUrlState()
    }

    function lookupPlaza(n){
      return plazas.find(p=>p.plaza === Number(n))
    }

    // Header click sorting: toggle sort on any th[data-key]
    function clearHeaderSortClasses(){
      document.querySelectorAll('th[data-key]').forEach(t=>{ t.classList.remove('sorted','asc','desc') })
      // reset arrow emphasis
      document.querySelectorAll('th[data-key] .sort-arrow .arrow').forEach(a=>a.style.opacity='0.35')
    }

    function setHeaderArrow(key,order){
      clearHeaderSortClasses()
      const th = document.querySelector('th[data-key="'+key+'"]')
      if(!th) return
      th.classList.add('sorted')
      th.classList.add(order === 'asc' ? 'asc' : 'desc')
      // highlight arrows
      const ascEl = th.querySelector('.sort-arrow .arrow.asc')
      const descEl = th.querySelector('.sort-arrow .arrow.desc')
      if(ascEl) ascEl.style.opacity = order === 'asc' ? '0.95' : '0.35'
      if(descEl) descEl.style.opacity = order === 'desc' ? '0.95' : '0.35'
      // sync selects
      document.getElementById('sortField').value = key
      document.getElementById('sortOrder').value = order
      // persist last sort
      localStorage.setItem('plazas_last_sort', JSON.stringify({field:key,order:order}))
    }

    // header click toggles order
    document.querySelectorAll('th[data-key]').forEach(th=>{
      th.addEventListener('click', (ev)=>{
        // if clicked on explicit arrow, that will be handled separately
        const key = th.dataset.key
        const last = JSON.parse(localStorage.getItem('plazas_last_sort')||'null') || {}
        let currentField = last.field || document.getElementById('sortField').value
        let currentOrder = last.order || document.getElementById('sortOrder').value
        if(currentField === key) currentOrder = currentOrder === 'asc' ? 'desc' : 'asc'
        else currentOrder = 'desc'
        setHeaderArrow(key,currentOrder)
        sortBy(key,currentOrder)
        updateUrlState()
      })
      // arrows inside header: clicking a specific arrow sets that order explicitly
      const ascEl = th.querySelector('.sort-arrow .arrow.asc')
      const descEl = th.querySelector('.sort-arrow .arrow.desc')
      if(ascEl){ ascEl.addEventListener('click', (e)=>{ e.stopPropagation(); const key = th.dataset.key; setHeaderArrow(key,'asc'); sortBy(key,'asc'); updateUrlState() }) }
      if(descEl){ descEl.addEventListener('click', (e)=>{ e.stopPropagation(); const key = th.dataset.key; setHeaderArrow(key,'desc'); sortBy(key,'desc'); updateUrlState() }) }
    })

    function updateUrlState(){
      const params = new URLSearchParams()
      params.set('sort', document.getElementById('sortField').value)
      params.set('order', document.getElementById('sortOrder').value)
      if(selected.size>0) params.set('selected', Array.from(selected).join(','))
      const newurl = window.location.pathname + '?' + params.toString()
      history.replaceState(null,'',newurl)
    }

    // Init
    fetch(DATA_URL).then(r=>r.json()).then(data=>{
      plazas = data
      // restore selection from localStorage
      const saved = JSON.parse(localStorage.getItem('plazas_selected')||'[]')
      if(Array.isArray(saved)) saved.forEach(n=>selected.add(Number(n)))
      applyUrlParams()
      // restore last sort from localStorage if present
      const last = JSON.parse(localStorage.getItem('plazas_last_sort')||'null')
      const field = last?.field || document.getElementById('sortField').value
      const order = last?.order || document.getElementById('sortOrder').value
      document.getElementById('sortField').value = field
      document.getElementById('sortOrder').value = order
      sortBy(field, order)
      setHeaderArrow(field, order)
      // render basic table for mobile/quick view
      renderBasicTable()
    })

    // Basic table show/hide handlers
    document.getElementById('btnShowBasic').addEventListener('click', ()=>{
      document.getElementById('basicTableWrap').style.display = 'block'
      document.getElementById('btnShowBasic').style.display = 'none'
      document.getElementById('btnHideBasic').style.display = 'inline-block'
      // scroll to the basic table for mobile
      document.getElementById('basicTable').scrollIntoView({behavior:'smooth',block:'center'})
    })
    document.getElementById('btnHideBasic').addEventListener('click', ()=>{
      document.getElementById('basicTableWrap').style.display = 'none'
      document.getElementById('btnShowBasic').style.display = 'inline-block'
      document.getElementById('btnHideBasic').style.display = 'none'
    })

    // --- Agent logic: chat-like interface ---
    function appendChat(who, html){
      const chat = document.getElementById('chat')
      const el = document.createElement('div')
      el.style.marginBottom = '8px'
      el.innerHTML = `<strong>${who}:</strong> <span>${html}</span>`
      chat.appendChild(el)
      chat.scrollTop = chat.scrollHeight
    }

    function agentReplyForPlaza(n){
      const p = lookupPlaza(n)
      if(!p) return `No encuentro la plaza ${n}.`
      const ahorro = p.estimado - p.precio
      // extra fields: metros, sotano if present in ubicacion detection
      const sotanoMatch = (p.ubicacion||'').match(/sotano\s*(\d+)/i) || (p.ubicacion||'').match(/sótano\s*(\d+)/i)
      const sotano = sotanoMatch ? sotanoMatch[1] : 'N/D'
      const por_m2 = p.precio && p.metros ? (p.precio / p.metros) : null
      const por_m2_estim = p.estimado && p.metros ? (p.estimado / p.metros) : null
      let out = ''
      out += `<div>Plaza <strong>${p.plaza}</strong> — ${p.ubicacion || ''} — ${p.metros} m²</div>`
      out += `<div>Precio: <strong>${p.precio_str}</strong> — Estimado: <strong>${fmtMoney(p.estimado)}</strong> — Ahorro: <strong style="color:${ahorro>=0? '#0a0':'#d00'}">${fmtMoney(ahorro)}</strong></div>`
      if(p.metros) out += `<div>Precio/m²: ${por_m2 ? fmtMoney(por_m2) : 'N/D'} — Estimado/m²: ${por_m2_estim ? fmtMoney(por_m2_estim) : 'N/D'}</div>`
      out += `<div>Sótano: <strong>${sotano}</strong></div>`
    // cost breakdown (approx)
    const itp = p.precio * 0.08
    const notMin = 400, notMax = 600
    const gestMin = 100, gestMax = 150
    const totalMin = itp + notMin + gestMin
    const totalMax = itp + notMax + gestMax
  out += `<div style="margin-top:8px"><strong>Gastos aproximados (compra 2ª mano):</strong></div>`
  out += `<div class="meta">💸 <span title="Impuesto de Transmisiones Patrimoniales (8%)">ITP (8%):</span> <strong>${fmtMoney(itp)}</strong></div>`
  out += `<div class="meta">📜 <span title="Gastos de notaría y registro estimados">Notaría + registro:</span> <strong>${fmtMoney(notMin)} – ${fmtMoney(notMax)}</strong></div>`
  out += `<div class="meta">🧾 <span title="Gestoría: tramitación administrativa (opcional)">Gestoría (opcional):</span> <strong>${fmtMoney(gestMin)} – ${fmtMoney(gestMax)}</strong></div>`
  out += `<div style="margin-top:6px">🔢 <strong>Total aproximado:</strong> ${fmtMoney(totalMin)} – ${fmtMoney(totalMax)}</div>`
      // actions
      out += `<div style="margin-top:6px"><button data-action="fav" data-plaza="${p.plaza}">Marcar favorito</button> <button data-action="sold" data-plaza="${p.plaza}">Marcar vendida</button></div>`
      return out
    }

    function processAgentInput(text){
      const t = (text||'').trim()
      if(!t) return
      appendChat('Tú', t.replace(/</g,'&lt;'))
      // detect commands: 'plaza 401' or just a number
      const plazaMatch = t.match(/\bplaza\s*(\d+)\b/i) || t.match(/^\s*(\d+)\s*$/)
      // detect APACAAQUITUCOCHE commands like: APACAAQUITUCOCHE marcar 401 favorito
      const special = t.match(/APACAAQUITUCOCHE\s+([^\n]+)/i)
      if(special){
        const cmd = special[1].trim()
        // e.g. 'marcar 401 favorito' or 'marcar 401 vendida'
        const m = cmd.match(/marcar\s*(\d+)\s*(favorito|vendida|vendido|vende)/i)
        if(m){
          const id = Number(m[1])
          const what = m[2].toLowerCase()
          if(/favorito/.test(what)){
            const favs = JSON.parse(localStorage.getItem('plazas_favs')||'{}')
            favs[id] = true
            localStorage.setItem('plazas_favs', JSON.stringify(favs))
            render()
            appendChat('APACAAQUITUCOCHE', `He marcado la plaza ${id} como favorito (por petición APACAAQUITUCOCHE).`)
            return
          }
          if(/vend|vendida|vende/.test(what)){
            const sold = JSON.parse(localStorage.getItem('plazas_sold')||'{}')
            sold[id] = true
            localStorage.setItem('plazas_sold', JSON.stringify(sold))
            render()
            appendChat('APACAAQUITUCOCHE', `He marcado la plaza ${id} como VENDIDA (por petición APACAAQUITUCOCHE).`)
            return
          }
        }
        appendChat('APACAAQUITUCOCHE', `Comando APACAAQUITUCOCHE no reconocido: ${cmd.replace(/</g,'&lt;')}`)
        return
      }
      if(plazaMatch){
        const id = Number(plazaMatch[1])
        const reply = agentReplyForPlaza(id)
        appendChat('APACAAQUITUCOCHE', reply)
        // attach event handlers for inline buttons
        setTimeout(()=>attachAgentButtons(),50)
        return
      }
      // fallback: try to detect a plain number
      const numOnly = t.match(/^(\d{2,4})$/)
      if(numOnly){
        const id = Number(numOnly[1])
        const reply = agentReplyForPlaza(id)
        appendChat('APACAAQUITUCOCHE', reply)
        setTimeout(()=>attachAgentButtons(),50)
        return
      }
      appendChat('APACAAQUITUCOCHE', 'No he entendido. Pide por ejemplo "plaza 401" o usa "APACAAQUITUCOCHE marcar 401 favorito"')
    }

    function attachAgentButtons(){
      document.querySelectorAll('#chat button[data-action]').forEach(b=>{
        if(b.dataset.bound) return;
        b.dataset.bound = '1';
        b.addEventListener('click', e=>{
          const a = b.dataset.action
          const id = Number(b.dataset.plaza)
          if(a === 'fav'){
            const favs = JSON.parse(localStorage.getItem('plazas_favs')||'{}')
            favs[id] = true
            localStorage.setItem('plazas_favs', JSON.stringify(favs))
            render();
            appendChat('APACAAQUITUCOCHE', `Plaza ${id} marcada como favorito.`)
          } else if(a === 'sold'){
            const sold = JSON.parse(localStorage.getItem('plazas_sold')||'{}')
            sold[id] = true
            localStorage.setItem('plazas_sold', JSON.stringify(sold))
            render();
            appendChat('APACAAQUITUCOCHE', `Plaza ${id} marcada como VENDIDA.`);
          }
        })
      })
    }

    document.getElementById('agentSend').addEventListener('click', ()=>{
      const val = document.getElementById('agentInput').value
      document.getElementById('agentInput').value = ''
      processAgentInput(val)
    })
    document.getElementById('agentInput').addEventListener('keydown', e=>{ if(e.key === 'Enter') { e.preventDefault(); document.getElementById('agentSend').click() } })
    document.getElementById('agentClear').addEventListener('click', ()=>{ document.getElementById('chat').innerHTML = '' })

  </script>
  </div>
</body>
</html>